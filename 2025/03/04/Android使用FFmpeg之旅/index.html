<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Ltt"><title>Android使用FFmpeg之旅 · Puppet</title><meta name="description" content="一、前言

1.1 如何在 Android 里使用 FFmpeg


二、下载资源

2.1 FFmpeg 源码下载
2.2 NDK 下载


三、编译 FFmpeg

3.1 配置 NDK 环境变量
3.2 修改原始脚本

3.2.1 修改 so 文件后缀


3.3 编写自己的脚本
3.4 运行"><meta name="keywords" content="技术博客,Hexo,Android,Linux,HTML,Java"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">首页</a></li><li> <a href="/archives">归档</a></li><li> <a href="/tags">标签</a></li><li> <a href="/about">关于</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:220px;" alt="favicon"><h3 title=""><a href="/">Puppet</a></h3><div class="description"><p>心之所愿，无事不成。<br> Nothing is impossible to a willing heart.</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/puppet16"><i class="fa fa-github"></i></a></li><li><a href="mailto:mailto:2542469086@qq.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY=http://sighttp.qq.com/authd?IDKEY="><i class="fa fa-qq"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/"><i class="fa fa-mortar-board"></i></a></li></ul></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Ltt</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Android使用FFmpeg之旅</a></h3></div><div class="post-content"><p><div class="toc">
<!-- toc -->
<ul>
<li><a href="#%E4%B8%80-%E5%89%8D%E8%A8%80">一、前言</a>
<ul>
<li><a href="#11-%E5%A6%82%E4%BD%95%E5%9C%A8-android-%E9%87%8C%E4%BD%BF%E7%94%A8-ffmpeg">1.1 如何在 Android 里使用 FFmpeg</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8C-%E4%B8%8B%E8%BD%BD%E8%B5%84%E6%BA%90">二、下载资源</a>
<ul>
<li><a href="#21-ffmpeg-%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD">2.1 <code>FFmpeg</code> 源码下载</a></li>
<li><a href="#22-ndk-%E4%B8%8B%E8%BD%BD">2.2 <code>NDK</code> 下载</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89-%E7%BC%96%E8%AF%91-ffmpeg">三、编译 FFmpeg</a>
<ul>
<li><a href="#31-%E9%85%8D%E7%BD%AE-ndk-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">3.1 配置 <code>NDK</code> 环境变量</a></li>
<li><a href="#32-%E4%BF%AE%E6%94%B9%E5%8E%9F%E5%A7%8B%E8%84%9A%E6%9C%AC">3.2 修改原始脚本</a>
<ul>
<li><a href="#321-%E4%BF%AE%E6%94%B9-so-%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80">3.2.1 修改 <code>so</code> 文件后缀</a></li>
</ul>
</li>
<li><a href="#33-%E7%BC%96%E5%86%99%E8%87%AA%E5%B7%B1%E7%9A%84%E8%84%9A%E6%9C%AC">3.3 编写自己的脚本</a></li>
<li><a href="#34-%E8%BF%90%E8%A1%8C%E8%87%AA%E5%B7%B1%E7%9A%84%E8%84%9A%E6%9C%AC">3.4 运行自己的脚本</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9B-%E5%9C%A8-android-%E4%B8%AD%E4%BD%BF%E7%94%A8-ffmpeg">四、在 Android 中使用 FFmpeg</a>
<ul>
<li><a href="#41-%E6%B7%BB%E5%8A%A0-ffmpeg-%E5%BA%93%E6%96%87%E4%BB%B6">4.1 添加 <code>FFmpeg</code> 库文件</a></li>
<li><a href="#42-%E7%BC%96%E5%86%99%E8%87%AA%E5%B7%B1%E7%9A%84-jni-%E4%BB%A3%E7%A0%81">4.2 编写自己的 <code>JNI</code> 代码</a></li>
<li><a href="#43-%E9%85%8D%E7%BD%AE-cmakeliststxt-%E6%96%87%E4%BB%B6">4.3 配置 <code>CMakeLists.txt</code> 文件</a></li>
</ul>
</li>
<li><a href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98">遇到的问题</a>
<ul>
<li><a href="#1-ffmpeg-%E4%B8%8E-ndk-%E7%89%88%E6%9C%AC%E4%B8%8D%E5%85%BC%E5%AE%B9">1 <code>FFmpeg</code> 与 <code>NDK</code> 版本不兼容</a></li>
<li><a href="#2-cpp-%E6%96%87%E4%BB%B6%E9%87%8C%E9%93%BE%E6%8E%A5%E4%B8%8D%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9A%84%E5%BA%93">2 cpp 文件里链接不到对应的库</a></li>
<li><a href="#3-%E4%B8%8D%E6%98%BE%E7%A4%BA%E6%89%93%E5%8D%B0%E7%9A%84%E6%97%A5%E5%BF%97">3 不显示打印的日志</a></li>
<li><a href="#4-codec-permission-defined">4 codec permission defined</a></li>
<li><a href="#5-error-x264-not-found-using-pkg-config">5 <code>ERROR: x264 not found using pkg-config</code></a></li>
<li><a href="#6-%E6%97%B6%E9%97%B4%E6%88%B3%E9%9D%9E%E5%8D%95%E8%B0%83%E9%80%92%E5%A2%9E">6 时间戳非单调递增</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
</div>
<h2><a href="#一-前言" class="header-anchor">#</a><span id="一-前言">一、前言</span></h2>
<p><code>FFmpeg</code> 是一个跨平台的多媒体库，也是目前音视频领域应用最广泛的库。包括 <code>libavcodec</code>、<code>libavformat</code>、<code>libavutil</code>、<code>libavdevice</code>、<code>libavfilter</code>、<code>libswscale</code>、<code>libswresample</code>、<code>libpostproc</code> 等模块。</p>
<ul>
<li><code>avcodec</code> 用于编解码</li>
<li><code>avformat</code> 用于解封装</li>
<li><code>avutil</code> 是提供工具类</li>
<li><code>avdevice</code> 用于各平台的设备接入</li>
<li><code>avfilter</code> 提供滤镜操作</li>
<li><code>swscale</code> 提供图像缩放与像素格式转换</li>
<li><code>swresample</code>提供音频重采样</li>
<li><code>postproc</code>提供高级处理</li>
</ul>
<h3><a href="#11-如何在-android-里使用-ffmpeg" class="header-anchor">#</a><span id="11-如何在-android-里使用-ffmpeg">1.1 如何在 Android 里使用 FFmpeg</span></h3>
<p><strong>第一步，编译 FFmpeg</strong></p>
<p><code>FFmpeg</code> 是一个用<code>C</code>编写的开源多媒体框架，<code>Android</code> 无法直接使用，需要将其编译为 <code>Android</code> 支持的动态库 <em>( .so文件)</em>。<br>
编译时需要针对 <code>Android</code> 的 <code>CPU</code> 架构 <em>(如ARMv7、ARM64、x86等)</em> 进行交叉编译。</p>
<p><strong>第二步，集成到 Android 项目，通过 JNI 调用 FFmpeg</strong></p>
<p>在 <code>Android</code> 项目中，<code>Java</code> 代码无法直接调用 <code>C</code> 代码，需要通过 <code>JNI</code> 实现 <code>Java/Kotlin</code> 与 <code>C</code> 的交互。</p>
<ol>
<li>编写 <code>JNI</code> 层代码，封装 <code>FFmpeg</code> 的功能，供 <code>Java/kotlin</code> 调用。</li>
<li>将编译好的 <code>FFmpeg</code> 库和 <code>JNI</code> 代码集成到 <code>Android Studio</code> 项目中。</li>
<li>使用 <code>CMake</code> 或 <code>NDK-Build</code> 配置项目的构建过程。</li>
</ol>
<h2><a href="#二-下载资源" class="header-anchor">#</a><span id="二-下载资源">二、下载资源</span></h2>
<p>编译 <code>FFmpeg</code> 前，要下载两个东西：<code>FFmpeg</code> 源码、<code>NDK</code>。</p>
<blockquote>
<p>我所使用的版本：</p>
<ul>
<li><strong><code>FFmpeg</code>源码：7.1.1</strong></li>
<li><strong><code>NDK</code>：22.1.7171670</strong></li>
</ul>
</blockquote>
<h3><a href="#21-ffmpeg-源码下载" class="header-anchor">#</a><span id="21-ffmpeg-源码下载">2.1 <code>FFmpeg</code> 源码下载</span></h3>
<p>下载源码有两种方式：</p>
<ul>
<li>直接去官网下载，官网地址：<a target="_blank" rel="noopener" href="https://ffmpeg.org/download.html">https://ffmpeg.org/download.html</a></li>
<li>使用 <code>git</code> 命令：git clone <a target="_blank" rel="noopener" href="https://github.com/FFmpeg/FFmpeg.git">https://github.com/FFmpeg/FFmpeg.git</a></li>
</ul>
<h3><a href="#22-ndk-下载" class="header-anchor">#</a><span id="22-ndk-下载">2.2 <code>NDK</code> 下载</span></h3>
<p>下载 <code>NDK</code> 有两种方式：</p>
<ul>
<li>
<p>去 <code>Android</code> 官网下载 <code>ndk</code> 源码，官网地址：<a target="_blank" rel="noopener" href="https://developer.android.com/ndk/downloads?hl=zh-cn">https://developer.android.com/ndk/downloads?hl=zh-cn</a></p>
</li>
<li>
<p>使用 <code>Android Studio</code> 下载NDK</p>
</li>
</ul>
<img src="/2025/03/04/Android%E4%BD%BF%E7%94%A8FFmpeg%E4%B9%8B%E6%97%85/pic_download_ndk.jpg" width="800">
 <!-- ![image](/Android使用FFmpeg之旅/pic_download_ndk.jpg) -->
<p>如上图所示，先打开 <code>File -&gt; Setting</code> 对话框，然后按 1 --&gt; 2 --&gt; 3 --&gt; 4 步骤进行操作。</p>
<h2><a href="#三-编译-ffmpeg" class="header-anchor">#</a><span id="三-编译-ffmpeg">三、编译 FFmpeg</span></h2>
<p>编译 <code>FFmpeg</code> 需要 <code>NDK</code> 的参与，因此要先配置 <code>NDK</code> 环境变量</p>
<h3><a href="#31-配置-ndk-环境变量" class="header-anchor">#</a><span id="31-配置-ndk-环境变量">3.1 配置 <code>NDK</code> 环境变量</span></h3>
<p>在编译 <code>FFmpeg</code> 前，要先配置 <code>NDK</code> 的环境变量。以 <code>Mac</code> 为例，有如下步骤：</p>
<ol>
<li>使用 <code>vim ~/.bash_profile</code> 命令，打开 <code>bash_profile</code> 文件</li>
<li>然后按 <code>E</code> 打开文件的编辑模式，再按 <code>I</code> 打开插入模式，此时就可以向文件里输入内容了</li>
<li>在文件里添加  <code>export NDK_PATH=/Users/luck/Library/Android/sdk/ndk/22.1.7171670</code></li>
<li>按 <code>esc</code> 键 退出插入模式，然后输入 <strong><code>:wq</code></strong> 保存并退出文件</li>
</ol>
<h3><a href="#32-修改原始脚本" class="header-anchor">#</a><span id="32-修改原始脚本">3.2 修改原始脚本</span></h3>
<p>在 <code>FFmpeg</code> 源码目录有个 <strong><code>configure</code></strong> 配置脚本，使用 <code>./configure --help</code> 可以查看命令相关内容。</p>
<h4><a href="#321-修改-so-文件后缀" class="header-anchor">#</a><span id="321-修改-so-文件后缀">3.2.1 修改 <code>so</code> 文件后缀</span></h4>
<p>修改原始脚本的目的是为了修改 <code>so</code> 文件的后缀。默认编译出来的 <code>so</code> 库包括 <code>avcodec</code> 、<code>avformat</code>、<code>avutil</code>、<code>avdevice</code>、<code>avfilter</code>、<code>swscale</code>、<br>
<code>swresample</code> 等，编译出来的 <code>so</code> 是个软链接，真正 <code>so</code> 名字后缀带有一长串主版本号与子版本号，这样的 <code>so</code> 名字在 <code>Adnroid</code> 平台无法识别。所以我们需要修改一下。<br>
首先打开 <code>configure</code> 文件，然后全局搜索 <strong><code>SLIBNAME</code></strong>，会出来如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SLIBNAME_WITH_MAJOR=<span class="string">&#x27;$(SLIBNAME).$(LIBMAJOR)&#x27;</span></span><br><span class="line"></span><br><span class="line">LIB_INSTALL_EXTRA_CMD=<span class="string">&#x27;$$(RANLIB)&quot;$(LIBDIR)/$(LIBNAME)&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line">SLIB_INSTALL_NAME=<span class="string">&#x27;$(SLIBNAME_WITH_VERSION)&#x27;</span></span><br><span class="line"></span><br><span class="line">SLIB_INSTALL_LINKS=<span class="string">&#x27;$(SLIBNAME_WITH_MAJOR)$(SLIBNAME)&#x27;</span></span><br></pre></td></tr></table></figure>
<p>将其替换为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SLIBNAME_WITH_MAJOR=&#x27;$(SLIBPREF)$(FULLNAME)-$(LIBMAJOR)$(SLIBSUF)&#x27;</span><br><span class="line"></span><br><span class="line">LIB_INSTALL_EXTRA_CMD=&#x27;$$(RANLIB)&quot;$(LIBDIR)/$(LIBNAME)&quot;&#x27;</span><br><span class="line"></span><br><span class="line">SLIB_INSTALL_NAME=&#x27;$(SLIBNAME_WITH_MAJOR)&#x27;</span><br><span class="line"></span><br><span class="line">SLIB_INSTALL_LINKS=&#x27;$(SLIBNAME)&#x27;</span><br></pre></td></tr></table></figure>
<h3><a href="#33-编写自己的脚本" class="header-anchor">#</a><span id="33-编写自己的脚本">3.3 编写自己的脚本</span></h3>
<p>在 <code>FFmpeg</code> 源码根目录创建一个 <code>shell</code> 脚本，<a target="_blank" rel="noopener" href="http://xn--buildff-e73k064b85a338a8r7c.sh">比如命名为buildff.sh</a>，以 <code>mac</code> 编译环境为例，下面例子是采用 <code>ndk</code> 新版的 <code>clang</code> 进行编译。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">make clean</span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line">archbit=64</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$archbit</span> -eq 64 ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;build for 64bit&quot;</span></span><br><span class="line">ARCH=aarch64</span><br><span class="line">CPU=armv8-a</span><br><span class="line">API=21</span><br><span class="line">PLATFORM=aarch64</span><br><span class="line">ANDROID=android</span><br><span class="line">CFLAGS=<span class="string">&quot;&quot;</span></span><br><span class="line">LDFLAGS=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;build for 32bit&quot;</span></span><br><span class="line">ARCH=arm</span><br><span class="line">CPU=armv7-a</span><br><span class="line">API=16</span><br><span class="line">PLATFORM=armv7a</span><br><span class="line">ANDROID=androideabi</span><br><span class="line">CFLAGS=<span class="string">&quot;-mfloat-abi=softfp -march=<span class="variable">$CPU</span>&quot;</span></span><br><span class="line">LDFLAGS=<span class="string">&quot;-Wl,--fix-cortex-a8&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> NDK=/Users/luck/Library/Android/sdk/ndk/22.1.7171670</span><br><span class="line"><span class="built_in">export</span> TOOLCHAIN=<span class="variable">$NDK</span>/toolchains/llvm/prebuilt/darwin-x86_64/bin</span><br><span class="line"><span class="built_in">export</span> SYSROOT=<span class="variable">$NDK</span>/toolchains/llvm/prebuilt/darwin-x86_64/sysroot</span><br><span class="line"><span class="built_in">export</span> CROSS_PREFIX=<span class="variable">$TOOLCHAIN</span>/<span class="variable">$ARCH</span>-linux-<span class="variable">$ANDROID</span>-</span><br><span class="line"><span class="built_in">export</span> CC=<span class="variable">$TOOLCHAIN</span>/<span class="variable">$PLATFORM</span>-linux-$ANDROID<span class="variable">$API</span>-clang</span><br><span class="line"><span class="built_in">export</span> CXX=<span class="variable">$TOOLCHAIN</span>/<span class="variable">$PLATFORM</span>-linux-$ANDROID<span class="variable">$API</span>-clang++</span><br><span class="line"><span class="built_in">export</span> PREFIX=./ffmpeg-android/<span class="variable">$CPU</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> build_android &#123;</span><br><span class="line">    ./configure \</span><br><span class="line">    --prefix=<span class="variable">$PREFIX</span> \</span><br><span class="line">    --cross-prefix=<span class="variable">$CROSS_PREFIX</span> \</span><br><span class="line">    --target-os=android \</span><br><span class="line">    --<span class="built_in">arch</span>=<span class="variable">$ARCH</span> \</span><br><span class="line">    --cpu=<span class="variable">$CPU</span> \</span><br><span class="line">    --cc=<span class="variable">$CC</span> \</span><br><span class="line">    --cxx=<span class="variable">$CXX</span> \</span><br><span class="line">    --nm=<span class="variable">$TOOLCHAIN</span>/<span class="variable">$ARCH</span>-linux-<span class="variable">$ANDROID</span>-nm \</span><br><span class="line">    --strip=<span class="variable">$TOOLCHAIN</span>/<span class="variable">$ARCH</span>-linux-<span class="variable">$ANDROID</span>-strip \</span><br><span class="line">    --enable-cross-compile \</span><br><span class="line">    --sysroot=<span class="variable">$SYSROOT</span> \</span><br><span class="line">    --extra-cflags=<span class="string">&quot;<span class="variable">$CFLAGS</span>&quot;</span> \</span><br><span class="line">    --extra-ldflags=<span class="string">&quot;<span class="variable">$LDFLAGS</span>&quot;</span> \</span><br><span class="line">    --extra-ldexeflags=-pie \</span><br><span class="line">    --enable-runtime-cpudetect \</span><br><span class="line">    --disable-static \</span><br><span class="line">    --enable-shared \</span><br><span class="line">    --disable-ffprobe \</span><br><span class="line">    --disable-ffplay \</span><br><span class="line">    --disable-ffmpeg \</span><br><span class="line">    --disable-debug \</span><br><span class="line">    --disable-doc \</span><br><span class="line">    --enable-avfilter \</span><br><span class="line">    --enable-decoders \</span><br><span class="line">    --enable-jni \</span><br><span class="line">    --enable-mediacodec \</span><br><span class="line">    --enable-decoder=h264_mediacodec \</span><br><span class="line">    --enable-decoder=hevc_mediacodec \</span><br><span class="line">    --enable-decoder=mpeg4_mediacodec \</span><br><span class="line">    --enable-hwaccel=h264_mediacodec</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$ADDITIONAL_CONFIGURE_FLAG</span></span><br><span class="line"></span><br><span class="line">    make</span><br><span class="line">    make install</span><br><span class="line">&#125;</span><br><span class="line">build_android</span><br></pre></td></tr></table></figure>
<p>如上所示，<code>shell</code>脚本分为 4 个阶段：</p>
<ol>
<li>第一段，<code>make clean</code> 清除缓存，<code>set -e</code> 设置编译出错后马上退出，<code>archbit=xx</code> 指定 <code>cpu</code> 架构是 <em>32</em> 位还是 <em>64</em> 位</li>
<li>第二段，<code>if...else...fi</code> 用来条件编译不同 <code>cpu</code> 架构对应字段的值</li>
<li>第三段，用 <code>export</code> 关键字声明宏定义，其中 <strong><code>PREFIX</code> 是指定输出文件路径</strong></li>
<li>第四段，是一个执行函数，按照 <code>ffmpeg</code> 的 <code>configure</code> 规范进行编写。函数里面的 <code>enable</code> 代表开启，<code>disable</code> 代表关闭，也就是对 <code>ffmpeg</code> 进行剪裁，根据我们需要的功能进行 <code>enable</code>。
<ul>
<li><code>make</code> 命令是执行编译，<code>make install</code> 命令是执行安装</li>
<li>最后的 <code>build_android</code> 是执行函数</li>
</ul>
</li>
</ol>
<h3><a href="#34-运行自己的脚本" class="header-anchor">#</a><span id="34-运行自己的脚本">3.4 运行自己的脚本</span></h3>
<ol>
<li>初次执行 <code>shell</code> 脚本，需要修改脚本权限，使用 <code>linux</code> 命令：<strong><code>chmod 777 buildff.sh</code></strong>。</li>
<li>执行脚本只需要一行命令, 即在命令行输入<code>./buildff.sh</code>。编译过程中，命令行会不断打印编译日志，等待命令行输出 <code>INSTALL xxx</code> 关键字代表编译完成。</li>
</ol>
<p>编译后会在目标目录下生成一个目录，目录名为前面指定的 <code>CPU</code> 架构，在这个架构目录下才是真正产出的内容。如下图所示：</p>
 <img src="/2025/03/04/Android%E4%BD%BF%E7%94%A8FFmpeg%E4%B9%8B%E6%97%85/pic_ffmpeg_output.png" width="400">
<ul>
<li><code>lib</code>, 该目录内存放的是 <code>so</code> 文件</li>
<li><code>include</code>, 该目录内存放的是库的头文件</li>
</ul>
<h2><a href="#四-在-android-中使用-ffmpeg" class="header-anchor">#</a><span id="四-在-android-中使用-ffmpeg">四、在 Android 中使用 FFmpeg</span></h2>
<p>由于 <code>FFmpeg</code> 是 <code>c</code> 语言写的代码，所以要在 <code>Android Studio</code> 中调用 <code>FFmpeg</code> 的核心思路是将 <code>FFmpeg</code> 编译为 <code>Android</code> 可用的库 <em>(.so文件)</em> 然后通过 <code>JNI</code> <em>(Java Native Interface)</em> 调用 <code>FFmpeg</code> 的功能。经过上面的步骤，已经将 <code>FFmpeg</code> 编译好了，下面就是将其添加到工程里</p>
<blockquote>
<p><code>JNI</code> 是 <code>Java</code> 本地接口，定义 <code>Android</code> 从应用代码 <em>(以 <code>Java</code> 或 <code>kotlin</code> 编程语言编写)</em> 到本地代码 <em>(<code>C/C++</code> 编写)</em> 交互编译成字节码的一种方式</p>
</blockquote>
<h3><a href="#41-添加-ffmpeg-库文件" class="header-anchor">#</a><span id="41-添加-ffmpeg-库文件">4.1 添加 <code>FFmpeg</code> 库文件</span></h3>
<p><strong>创建目录及文件</strong></p>
 <!-- ![image](/Android使用FFmpeg之旅/pic_jni_struct.jpg) -->
 <img src="/2025/03/04/Android%E4%BD%BF%E7%94%A8FFmpeg%E4%B9%8B%E6%97%85/pic_jni_struct.jpg" width="400">
<p>如上所示，首先在 <code>app/src/main</code> 下创建一个 <code>cpp</code> 目录，用于编写 <code>JNI</code> 代码以及存放 <code>FFmpeg</code> 库文件，然后创建如下内容：</p>
<ol>
<li><code>arm64-v8a</code> 目录，该目录名称要写支持的 <code>CPU</code> 架构，还要与 <code>FFmpeg</code> 编译时选用的 <code>CPU</code> 架构一致。该目录存放的是编译出来的一系列的 <code>so</code> 文件</li>
<li><code>include</code> 目录，该目录下存放的各库一系列的头文件，也就是编译产物里 <code>include</code> 目录下的内容</li>
<li>创建 <code>CMakeLists.txt</code> 文件，该文件是 <code>CMake</code> 构建系统的核心配置文件，用于定义项目的编译规则、依赖管理和平台适配等</li>
</ol>
<p><strong>配置 <code>gradle</code> 文件</strong></p>
<p>我的 <code>gradle</code> 文件使用的 <code>kts</code>，所以配置内容如下：</p>
<figure class="highlight kts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        externalNativeBuild &#123;</span><br><span class="line">            cmake &#123;</span><br><span class="line">                cppFlags.add(<span class="string">&quot;-std=c++11&quot;</span>)</span><br><span class="line">                abiFilters.add(<span class="string">&quot;arm64-v8a&quot;</span>)<span class="comment">// 根据你的需求选择 ABI</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ndk &#123;</span><br><span class="line">            abiFilters.add(<span class="string">&quot;arm64-v8a&quot;</span>) <span class="comment">// 同上</span></span><br><span class="line">            ldLibs?.add(<span class="string">&quot;android&quot;</span>) ?: mutableListOf(<span class="string">&quot;log&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><a href="#42-编写自己的-jni-代码" class="header-anchor">#</a><span id="42-编写自己的-jni-代码">4.2 编写自己的 <code>JNI</code> 代码</span></h3>
<p>在 <strong>C++</strong> 中，通常将代码分为头文件 <em>（.h 或 .hpp）</em> 和源文件 <em>（.cpp）</em> 两种类型。在实际开发中，<strong>头文件主要用于暴露接口和声明，而源文件用于实现具体的功能</strong>。<br>
所以，在 <code>cpp</code> 目录下创建<code>C</code>代码所需文件： <code>native-lib.h</code>、<code>native-lib.cpp</code> 两个文件。然后在 <code>java</code> 层创建一个 <code>RecorderHelper</code> 的文件，用于调用 <code>C</code> 编写的代码</p>
<p>下面以获取 <code>FFmpeg</code> 版本号为例，进行代码撰写</p>
<p><strong>首先在 <code>Java/kotlin</code> 代码层去创建一个获取版本号的方法</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RecorderHelper</span> &#123;</span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native-lib&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">external</span> <span class="function"><span class="keyword">fun</span> <span class="title">getFFmpegVersion</span><span class="params">()</span></span>: String</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>调用 <code>C</code> 层代码的方法，在 <code>kotlin</code> 语法里，要添加 <code>external</code> 关键字；<code>Java</code> 语法里，使用 <code>native</code> 关键字</li>
<li>最关键的是，要通过<code>System.loadLibrary()</code> 方法，添加 <code>C</code> 代码所在的库</li>
</ol>
<p><strong>然后在 <code>native-lib.h</code> 文件里对获取版本号方法进行声明</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _Included_cn_luck_screenrecord_ffmpeg_RecorderHelper</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _Included_cn_luck_screenrecord_ffmpeg_RecorderHelper</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_cn_luck_screenrecord_ffmpeg_RecorderHelper_getFFmpegVersion__</span><span class="params">(JNIEnv *, jobject)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><strong>最后在 <code>native-lib.cpp</code> 文件里对方法进行实现</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libavutil/version.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_cn_luck_screenrecord_ffmpeg_RecorderHelper_getFFmpegVersion__</span><span class="params">(JNIEnv *env, jobject obj)</span> </span>&#123;</span><br><span class="line">        <span class="type">char</span> version[<span class="number">100</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(version, <span class="built_in">sizeof</span>(version), <span class="string">&quot;FFmpeg version %d.%d.%d&quot;</span>, LIBAVUTIL_VERSION_MAJOR, LIBAVUTIL_VERSION_MINOR, LIBAVUTIL_VERSION_MICRO);</span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;ffmpeg version: %s&quot;</span>, version);</span><br><span class="line">        <span class="keyword">return</span> (*env).<span class="built_in">NewStringUTF</span>(version);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3><a href="#43-配置-cmakeliststxt-文件" class="header-anchor">#</a><span id="43-配置-cmakeliststxt-文件">4.3 配置 <code>CMakeLists.txt</code> 文件</span></h3>
<p>配置内容如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cmake_minimum_required</span>(VERSION <span class="number">3.10</span>)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"># 设置 FFmpeg 头文件路径</span><br><span class="line"><span class="built_in">include_directories</span>(include)</span><br><span class="line"></span><br><span class="line"># 设置 FFmpeg 库路径</span><br><span class="line"><span class="built_in">set</span>(FFMPEG_LIB_DIR $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/$&#123;ANDROID_ABI&#125;)</span><br><span class="line"></span><br><span class="line"># 添加 FFmpeg 库</span><br><span class="line"><span class="built_in">add_library</span>(avcodec SHARED IMPORTED)</span><br><span class="line"><span class="built_in">set_target_properties</span>(avcodec PROPERTIES IMPORTED_LOCATION $&#123;FFMPEG_LIB_DIR&#125;/libavcodec.so)</span><br><span class="line"></span><br><span class="line"><span class="built_in">add_library</span>(avformat SHARED IMPORTED)</span><br><span class="line"><span class="built_in">set_target_properties</span>(avformat PROPERTIES IMPORTED_LOCATION $&#123;FFMPEG_LIB_DIR&#125;/libavformat.so)</span><br><span class="line"></span><br><span class="line"><span class="built_in">add_library</span>(avutil SHARED IMPORTED)</span><br><span class="line"><span class="built_in">set_target_properties</span>(avutil PROPERTIES IMPORTED_LOCATION $&#123;FFMPEG_LIB_DIR&#125;/libavutil.so)</span><br><span class="line"></span><br><span class="line"><span class="built_in">add_library</span>(swresample SHARED IMPORTED)</span><br><span class="line"><span class="built_in">set_target_properties</span>(swresample PROPERTIES IMPORTED_LOCATION $&#123;FFMPEG_LIB_DIR&#125;/libswresample.so)</span><br><span class="line"></span><br><span class="line"><span class="built_in">add_library</span>(swscale SHARED IMPORTED)</span><br><span class="line"><span class="built_in">set_target_properties</span>(swscale PROPERTIES IMPORTED_LOCATION $&#123;FFMPEG_LIB_DIR&#125;/libswscale.so)</span><br><span class="line"></span><br><span class="line"># 创建你的本地库</span><br><span class="line"><span class="built_in">add_library</span>(native-muxer SHARED native-muxer.cpp)</span><br><span class="line"></span><br><span class="line"># 查找 log 库</span><br><span class="line"><span class="built_in">find_library</span>(log-lib log)</span><br><span class="line"></span><br><span class="line"># 创建你的本地库</span><br><span class="line"><span class="built_in">add_library</span>(native-lib SHARED native-lib.cpp)</span><br><span class="line"></span><br><span class="line"># 链接 FFmpeg 库</span><br><span class="line"><span class="built_in">target_link_libraries</span>(native-lib avcodec avformat avutil swresample swscale $&#123;log-lib&#125;)</span><br><span class="line"></span><br><span class="line"># 确保 native-lib 可以使用 FFmpeg 头文件</span><br><span class="line"><span class="built_in">target_include_directories</span>(native-lib PRIVATE include)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2><a href="#遇到的问题" class="header-anchor">#</a><span id="遇到的问题">遇到的问题</span></h2>
<h3><a href="#1-ffmpeg-与-ndk-版本不兼容" class="header-anchor">#</a><span id="1-ffmpeg-与-ndk-版本不兼容">1 <code>FFmpeg</code> 与 <code>NDK</code> 版本不兼容</span></h3>
<p>少张报错图</p>
<p>报错如图所示，找不到 ``，发现是因为在新版本的 <code>NDK</code> 中移除了该命令，一步步试错，最终确定 <code>NDK</code> 版本为 <strong>22.1.7171670</strong> 时，版本兼容了</p>
<h3><a href="#2-cpp-文件里链接不到对应的库" class="header-anchor">#</a><span id="2-cpp-文件里链接不到对应的库">2 cpp 文件里链接不到对应的库</span></h3>
<p>少张报错图</p>
<p>报错如上图所示，在 <code>Android Studio</code> 里点击能够导航到对应的头文件，但是运行就是报错，这是因为 <code>#include</code> 必须要放到 <code>extern &quot;C&quot; &#123;&#125;</code> 内，如下代码所示导入，就正常了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libavutil/pixdesc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libavutil/version.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libavutil/time.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libavutil/opt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libavformat/avformat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libavcodec/avcodec.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libswscale/swscale.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libswresample/swresample.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libavutil/imgutils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 代码逻辑 。。。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><a href="#3-不显示打印的日志" class="header-anchor">#</a><span id="3-不显示打印的日志">3 不显示打印的日志</span></h3>
<h3><a href="#4-codec-permission-defined" class="header-anchor">#</a><span id="4-codec-permission-defined">4 codec permission defined</span></h3>
<p>使用 <code>avcodec_open2()</code> 创建 <code>videoCodec</code> 时，返回值经过转换后信息为 ：<code>Permission denied</code>。经过检查发现，使用 <code>codec</code> 权限被拒，是因为编译的 <code>FFmpeg</code> 里没有添加 <code>x264</code> 库。</p>
<p><strong>本地编译并安装<code>x264</code>库</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 下载</span><br><span class="line">git clone --depth 1 https://code.videolan.org/videolan/x264.git</span><br></pre></td></tr></table></figure>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 配置架构（32 位 或 64 位）</span><br><span class="line">ARCH=aarch64        # 32-bit: arm (适用于 armv7-a) | 64-bit: aarch64</span><br><span class="line">CPU=armv8-a     # 目标 CPU (32-bit: armv7-a | 64-bit: armv8-a)</span><br><span class="line">API=21          # 目标 Android API 级别 (armv7 最低 API 16, 推荐 21)</span><br><span class="line">ANDROID=android  # (32-bit: androideabi | 64-bit: android)</span><br><span class="line">CFLAGS=&quot;-mfloat-abi=softfp -march=$CPU&quot;</span><br><span class="line">LDFLAGS=&quot;-Wl,--fix-cortex-a8&quot;</span><br><span class="line"></span><br><span class="line"># Android NDK 路径（请修改为你的路径）</span><br><span class="line">export NDK=/Users/luck/Library/Android/sdk/ndk/22.1.7171670</span><br><span class="line">export HOST_TAG=darwin-x86_64  # macOS (Linux 用户请改成 linux-x86_64)</span><br><span class="line">export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/$HOST_TAG</span><br><span class="line">export SYSROOT=$TOOLCHAIN/sysroot</span><br><span class="line">export PREFIX=$SYSROOT/usr/local</span><br><span class="line"></span><br><span class="line"># 32位 (armv7) 和 64位 (aarch64) 变量</span><br><span class="line">if [ &quot;$ARCH&quot; = &quot;arm&quot; ]; then</span><br><span class="line">    TARGET=&quot;armv7a-linux-$ANDROID&quot;</span><br><span class="line">    CROSS_PREFIX=$TOOLCHAIN/bin/arm-linux-$ANDROID-</span><br><span class="line">else</span><br><span class="line">    TARGET=&quot;aarch64-linux-android&quot;</span><br><span class="line">    CROSS_PREFIX=$TOOLCHAIN/bin/$TARGET-</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 其他工具变量</span><br><span class="line">export CC=$TOOLCHAIN/bin/$TARGET$API-clang</span><br><span class="line">export CXX=$TOOLCHAIN/bin/$TARGET$API-clang++</span><br><span class="line">export AR=$TOOLCHAIN/bin/llvm-ar</span><br><span class="line">export AS=$TOOLCHAIN/bin/llvm-as</span><br><span class="line">export LD=$TOOLCHAIN/bin/ld</span><br><span class="line">export STRIP=$TOOLCHAIN/bin/llvm-strip</span><br><span class="line">export NM=$TOOLCHAIN/bin/llvm-nm</span><br><span class="line">export RANLIB=$TOOLCHAIN/bin/llvm-ranlib</span><br><span class="line"></span><br><span class="line"># 编译 x264</span><br><span class="line">function build_x264 &#123;</span><br><span class="line">    ./configure \</span><br><span class="line">        --prefix=$PREFIX \</span><br><span class="line">        --host=$TARGET \</span><br><span class="line">        --cross-prefix=$CROSS_PREFIX \</span><br><span class="line">        --sysroot=$SYSROOT \</span><br><span class="line">        --enable-static \</span><br><span class="line">        --enable-pic \</span><br><span class="line">        --disable-opencl \</span><br><span class="line">        --disable-asm  # 可尝试启用 asm: `--enable-asm`</span><br><span class="line"></span><br><span class="line">    make -j$(nproc)</span><br><span class="line">    make install</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">build_x264</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过如上命令，下载 <code>x264</code> 库的源码，并进行编译，最后再安装。其中的编译时的配置：</p>
<ul>
<li>–enable-static：启用静态库，使 <code>FFmpeg</code> 可以静态链接 <code>x264</code>。</li>
<li>–enable-pic：用于 <code>Android</code> 和 <code>iOS</code>，防止动态库在 <code>ASLR</code> 下崩溃。</li>
<li>–disable-asm：若编译环境缺少汇编工具 <em>（如nasm）</em>，可禁用汇编优化以规避错误‌<br>
逐条运行如上命令后，最终会输出如下内容，表示成功安装：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">install -d /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/bin</span><br><span class="line">install x264 /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/bin</span><br><span class="line">install -d /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/include</span><br><span class="line">install -d /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/lib/pkgconfig</span><br><span class="line">install -m 644 ./x264.h x264_config.h /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/include</span><br><span class="line">install -m 644 x264.pc /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/lib/pkgconfig</span><br><span class="line">install -d /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/lib</span><br><span class="line"><span class="built_in">ln</span> -f -s libx264.so.164 /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/lib/libx264.so</span><br><span class="line">install -m 755 libx264.so.164 /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/lib</span><br><span class="line">install -d /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/lib</span><br><span class="line">install -m 644 libx264.a /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/lib</span><br><span class="line">/Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/bin/llvm-ranlib /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/lib/libx264.a</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>注意： 将 <code>x264</code> 安装到 <code>NDK</code> 里</strong></p>
<p><strong>在编译 <code>FFmpeg</code> 时添加 <code>x264</code> 库</strong></p>
<p>完整的编译脚本发下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">make clean</span><br><span class="line">set -e</span><br><span class="line">archbit=64</span><br><span class="line"></span><br><span class="line">if [ $archbit -eq 64 ];then</span><br><span class="line">echo &quot;build for 64bit&quot;</span><br><span class="line">ARCH=aarch64</span><br><span class="line">CPU=armv8-a</span><br><span class="line">API=21</span><br><span class="line">PLATFORM=aarch64</span><br><span class="line">ANDROID=android</span><br><span class="line">CFLAGS=&quot;-I/usr/local/include&quot;</span><br><span class="line">LDFLAGS=&quot;-L/usr/local/lib -lx264&quot;</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line">echo &quot;build for 32bit&quot;</span><br><span class="line">ARCH=arm</span><br><span class="line">CPU=armv7-a</span><br><span class="line">API=16</span><br><span class="line">PLATFORM=armv7a</span><br><span class="line">ANDROID=androideabi</span><br><span class="line">CFLAGS=&quot;-mfloat-abi=softfp -march=$CPU&quot;</span><br><span class="line">LDFLAGS=&quot;-Wl,--fix-cortex-a8&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">export NDK=/Users/luck/Library/Android/sdk/ndk/22.1.7171670</span><br><span class="line">export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/darwin-x86_64/bin</span><br><span class="line">export SYSROOT=$NDK/toolchains/llvm/prebuilt/darwin-x86_64/sysroot</span><br><span class="line">export CROSS_PREFIX=$TOOLCHAIN/$ARCH-linux-$ANDROID-</span><br><span class="line">export CC=$TOOLCHAIN/$PLATFORM-linux-$ANDROID$API-clang</span><br><span class="line">export CXX=$TOOLCHAIN/$PLATFORM-linux-$ANDROID$API-clang++</span><br><span class="line">export PREFIX=./ffmpeg-android/$CPU</span><br><span class="line">export PKG_CONFIG_PATH=$SYSROOT/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH</span><br><span class="line"></span><br><span class="line">function build_android &#123;</span><br><span class="line">    ./configure \</span><br><span class="line">    --prefix=$PREFIX \</span><br><span class="line">    --cross-prefix=$CROSS_PREFIX \</span><br><span class="line">    --target-os=android \</span><br><span class="line">    --arch=$ARCH \</span><br><span class="line">    --cpu=$CPU \</span><br><span class="line">    --cc=$CC \</span><br><span class="line">    --cxx=$CXX \</span><br><span class="line">    --nm=$TOOLCHAIN/$ARCH-linux-$ANDROID-nm \</span><br><span class="line">    --strip=$TOOLCHAIN/$ARCH-linux-$ANDROID-strip \</span><br><span class="line">    --enable-cross-compile \</span><br><span class="line">    --sysroot=$SYSROOT \</span><br><span class="line">    --extra-ldexeflags=-pie \</span><br><span class="line">    --enable-runtime-cpudetect \</span><br><span class="line">    --disable-static \</span><br><span class="line">    --enable-shared \</span><br><span class="line">    --disable-ffprobe \</span><br><span class="line">    --disable-ffplay \</span><br><span class="line">    --disable-ffmpeg \</span><br><span class="line">    --disable-debug \</span><br><span class="line">    --disable-doc \</span><br><span class="line">    --enable-avfilter \</span><br><span class="line">    --enable-decoders \</span><br><span class="line">    --enable-libx264 \</span><br><span class="line">    --extra-cflags=&quot;-I$SYSROOT/usr/local/include&quot; \</span><br><span class="line">    --extra-ldflags=&quot;-L$SYSROOT/usr/local/lib -lx264&quot; \</span><br><span class="line">    --enable-mediacodec \</span><br><span class="line">    --enable-decoder=h264_mediacodec \</span><br><span class="line">    --enable-decoder=hevc_mediacodec \</span><br><span class="line">    --enable-decoder=mpeg4_mediacodec \</span><br><span class="line">    --enable-hwaccel=h264_mediacodec \</span><br><span class="line">    --enable-encoder=libx264 \</span><br><span class="line">    --extra-libs=-ldl \</span><br><span class="line">    --enable-gpl \</span><br><span class="line">    --enable-pic \</span><br><span class="line">    --enable-small \</span><br><span class="line">    --disable-asm</span><br><span class="line">    </span><br><span class="line">    $ADDITIONAL_CONFIGURE_FLAG</span><br><span class="line"></span><br><span class="line">    make</span><br><span class="line">    echo $PKG_CONFIG_PATH</span><br><span class="line">    make install</span><br><span class="line">&#125;</span><br><span class="line">build_android</span><br></pre></td></tr></table></figure>
<p>如上所示，要在 <code>FFmpeg</code> 的编译命令 <code>configure</code> 后加上如上三条内容，其中：</p>
<ul>
<li><code>--enable-gpl</code>：<code>x264</code> 是 <code>GPL</code> 许可证，所以 <code>FFmpeg</code> 必须启用 <code>GPL</code>。</li>
<li><code>--enable-libx264</code>：启用 <code>x264</code> 编码支持。</li>
<li><code>--enable-pic</code>：防止 <code>ASLR</code> 崩溃 <em>（Android/iOS 需要）</em></li>
</ul>
<h3><a href="#5-error-x264-not-found-using-pkg-config" class="header-anchor">#</a><span id="5-error-x264-not-found-using-pkg-config">5 <code>ERROR: x264 not found using pkg-config</code></span></h3>
<p>出现如上错误，通常意味着 <code>pkg-config</code> 无法找到 <code>x264</code> 的 <code>pkg-config</code> 配置文件 <em>（即 x264.pc）</em></p>
<p>经过对 <code>x264</code> 库编译安装位置的修改，一开始放到 <code>Mac</code> 的 <code>usr/local</code> 里，后来放到 <code>NDK</code> 里，并进行过如下处理但是 <code>FFmpeg</code> 编译时始终最如上错误。暂未解决。</p>
<p><strong>检查 <code>x264</code> 的 <code>.pc</code> 文件路径</strong><br>
‌确认 <code>.pc</code> 文件存在性‌</p>
<p>执行以下命令查找 <code>x264.pc</code> 文件路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name <span class="string">&quot;x264.pc&quot;</span> 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
<p>若文件位于非标准路径 <em>（如/mylib/x264/pkgconfig）</em>，需手动将路径加入 <code>PKG_CONFIG_PATH</code>‌。</p>
<p><strong>‌修正 <code>PKG_CONFIG_PATH</code>环境变量‌</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PKG_CONFIG_PATH=/Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/lib/pkgconfig:<span class="variable">$PKG_CONFIG_PATH</span></span><br></pre></td></tr></table></figure>
<ol>
<li>使用 <code>vim ~/.bash_profile</code> 命令，打开 <code>bash_profile</code> 文件</li>
<li>然后按 <code>E</code> 打开文件的编辑模式，再按 <code>I</code> 打开插入模式，此时就可以向文件里输入内容了</li>
<li>在文件里添加  <code>export PKG_CONFIG_PATH=/Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/lib/pkgconfig</code></li>
<li>按 <code>esc</code> 键 退出插入模式，然后输入 <strong><code>:wq</code></strong> 保存并退出文件</li>
<li>执行 <code>source ~/.bash_profile‌</code> 刷新配置</li>
</ol>
<p><strong>验证 <code>pkg-config</code> 是否能识别 <code>x264</code></strong></p>
<p>执行以下命令测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkg-config --libs --cflags x264</span><br></pre></td></tr></table></figure>
<p>‌无输出‌：说明 <code>.pc</code> 文件路径未正确配置，但是输出了 <code>.pc</code> 文件路径</p>
<p>在 <code>ffbuild/</code> 里的 <code>config.log</code> 日志里有日志如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">WARNING: /Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android-pkg-config not found, library detection may fail.</span><br><span class="line">...</span><br><span class="line">/Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android21-clang --sysroot=/Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot -D_ISOC11_SOURCE -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -Dstrtod=avpriv_strtod -DPIC -I/Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/include -march=armv8-a -std=c17 -fPIE -fomit-frame-pointer -fPIC -pthread -c -o /var/folders/f5/jntt2zr54g10ls9j2tcn78q80000gn/T//ffconf.w0rPQQNa/test.o /var/folders/f5/jntt2zr54g10ls9j2tcn78q80000gn/T//ffconf.w0rPQQNa/test.c</span><br><span class="line">/var/folders/f5/jntt2zr54g10ls9j2tcn78q80000gn/T//ffconf.w0rPQQNa/test.c:3:24: warning: cast to smaller integer type &#x27;int&#x27; from &#x27;float (*)(float, float)&#x27; [-Wpointer-to-int-cast]</span><br><span class="line">int main(void)&#123; return (int) foo; &#125;</span><br><span class="line">                       ^~~~~~~~~</span><br><span class="line">1 warning generated.</span><br><span class="line">/Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android21-clang -L/Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot/usr/local/lib -lx264 --sysroot=/Users/luck/Library/Android/sdk/ndk/22.1.7171670/toolchains/llvm/prebuilt/darwin-x86_64/sysroot -march=armv8-a -Wl,--as-needed -Wl,-z,noexecstack -pie -fPIE -pie -o /var/folders/f5/jntt2zr54g10ls9j2tcn78q80000gn/T//ffconf.w0rPQQNa/test /var/folders/f5/jntt2zr54g10ls9j2tcn78q80000gn/T//ffconf.w0rPQQNa/test.o -lm -ldl</span><br><span class="line">check_pkg_config libdrm libdrm xf86drm.h drmGetVersion</span><br><span class="line">test_pkg_config libdrm libdrm xf86drm.h drmGetVersion</span><br><span class="line">false --exists --print-errors libdrm</span><br><span class="line">require_pkg_config libx264 x264 stdint.h x264.h x264_encoder_encode</span><br><span class="line">check_pkg_config libx264 x264 stdint.h x264.h x264_encoder_encode</span><br><span class="line">test_pkg_config libx264 x264 stdint.h x264.h x264_encoder_encode</span><br><span class="line">false --exists --print-errors x264</span><br><span class="line">ERROR: x264 not found using pkg-config</span><br></pre></td></tr></table></figure>
<p>在 <code>NDK</code> 里根本就没有 <code>aarch64-linux-android-pkg-config</code>, 未能解决这个问题</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/12136078/ffmpeg-for-android-toolchains-arm-linux-armeabi-eabi-pkg-config-is-there-any">https://stackoverflow.com/questions/12136078/ffmpeg-for-android-toolchains-arm-linux-armeabi-eabi-pkg-config-is-there-any</a></p>
<h3><a href="#6-时间戳非单调递增" class="header-anchor">#</a><span id="6-时间戳非单调递增">6 时间戳非单调递增</span></h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2025-03-06 15:58:15.433  4993-5075     cn....screenrecord  I  Muxed packet <span class="keyword">for</span> stream 1, size 233, pts 6779948</span><br><span class="line">2025-03-06 15:58:15.435  4993-5075     cn....screenrecord  I  Muxed packet <span class="keyword">for</span> stream 0, size 280, pts 7034026</span><br><span class="line">2025-03-06 15:58:15.437  4993-5075     cn....screenrecord  E  Error muxing packet <span class="keyword">for</span> stream 0, error code: -22, size 6540, pts 7019813</span><br><span class="line">2025-03-06 15:58:15.886  4993-5094     cn....screenrecord  I  Muxed packet <span class="keyword">for</span> stream 1, size 219, pts 7267547</span><br></pre></td></tr></table></figure>
<p>如上日志所示，在序号为 0 的 <code>stream</code> 流传入的数据，前一帧 <code>pts</code> 为 <em>7034026</em>，后一帧却是 <em>7019813</em>。</p>
<p><strong>解决方案</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算转换后的 pts，并确保它是单调递增的</span></span><br><span class="line"><span class="type">static</span> <span class="type">int64_t</span> lastVideoPts = <span class="number">-1</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int64_t</span> lastAudioPts = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int64_t</span> rescaledPts = av_rescale_q(pts, srcTimeBase, dstTimeBase);</span><br><span class="line"><span class="keyword">if</span> (streamIndex == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (rescaledPts &lt;= lastVideoPts) &#123;</span><br><span class="line">        rescaledPts = lastVideoPts + <span class="number">1</span>; <span class="comment">// 确保递增</span></span><br><span class="line">    &#125;</span><br><span class="line">    lastVideoPts = rescaledPts;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (streamIndex == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (rescaledPts &lt;= lastAudioPts) &#123;</span><br><span class="line">        rescaledPts = lastAudioPts + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    lastAudioPts = rescaledPts;</span><br><span class="line">&#125;</span><br><span class="line">pkt.pts = rescaledPts;</span><br></pre></td></tr></table></figure>
<p>添加如上代码：</p>
<ol>
<li>记录上一次 <code>pts</code>, 使用静态变量 <code>lastVideoPts</code> 和 <code>lastAudioPts</code> 分别记录视频和音频流上一次写入 <code>muxer</code> 的 <code>pts</code>。</li>
<li>调整不递增的 <code>pts</code>, 如果新计算出的 <code>rescaledPts</code> 小于或等于上一次的值，则将其调整为上一次值加一个单位，保证时间戳严格单调递增。</li>
</ol>
<br>
<br>
<br>
<br>
<br></p></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2025-03-04</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Android/" title="Android">Android </a><i class="fa fa-tag"></i><a class="tag" href="/tags/FFmpeg/" title="FFmpeg">FFmpeg </a><i class="fa fa-tag"></i><a class="tag" href="/tags/JNI/" title="JNI">JNI </a><i class="fa fa-tag"></i><a class="tag" href="/tags/C/" title="C">C </a><span class="leancloud_visitors"></span><span>大约4923个字, 16分钟24秒读完</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://puppet16.github.io/2025/03/04/Android使用FFmpeg之旅/,Puppet,Android使用FFmpeg之旅,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2025/03/08/JNI%E4%B8%8EFFmpeg%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/" title="JNI与FFmpeg基本语法">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2023/05/30/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%8D%81%E4%BA%94/" title="kotlin学习系列十五：协程源码篇三 协程运行">下一篇</a></li></ul></div><script src="/js/visitors.js"></script><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false, 
  verify:false|| false, 
  app_id:'xpSQCFiXzEQnCBUKrP6EHIUF-gzGzoHsz',
  app_key:'Ev5N03MrqLzS683mu92hf4RO',
  placeholder:'行至水穷处，坐看云起时...',
  path: window.location.pathname,
  serverURLs: '',
  visitor:true,
  recordIP:true,
  avatar:'mm'
})</script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><!-- Mermaid diagrams support--><script src="https://unpkg.com/mermaid@10.9.1/dist/mermaid.min.js"></script><script>if (window.mermaid) {
  mermaid.initialize({
    startOnLoad: true,
    securityLevel: 'loose',
    flowchart: { htmlLabels: true, useMaxWidth: true },
    classDiagram: {
      layout: 'elk',
      elk: {
        'elk.spacing.nodeNodeBetweenLayers': 200,
        'elk.spacing.nodeNode': 80
      }
    },
    theme: 'default',
    logLevel: 1
  });
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":20},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"dialog":{"enable":false,"hitokoto":true}});</script></body></html>