<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Ltt"><title>kotlin 学习系列八：注解 · Puppet</title><meta name="description" content="一、前言
二、注解的基本概念

1. 注解定义
2. 限定标注对象@Target
3. 指定作用时机
4. 添加参数
5. 注解使用
6. 明确注解的标注对象


三、内置注解

1. 元注解

1 @Target
2. @Retention


2. 标准库通用注解

1. @Metadata
2"><meta name="keywords" content="技术博客,Hexo,Android,Linux,HTML,Java"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">首页</a></li><li> <a href="/archives">归档</a></li><li> <a href="/tags">标签</a></li><li> <a href="/about">关于</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:220px;" alt="favicon"><h3 title=""><a href="/">Puppet</a></h3><div class="description"><p>心之所愿，无事不成。<br> Nothing is impossible to a willing heart.</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/puppet16"><i class="fa fa-github"></i></a></li><li><a href="mailto:mailto:2542469086@qq.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY=http://sighttp.qq.com/authd?IDKEY="><i class="fa fa-qq"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/"><i class="fa fa-mortar-board"></i></a></li></ul></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Ltt</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>kotlin 学习系列八：注解</a></h3></div><div class="post-content"><p><div class="toc">
<!-- toc -->
<ul>
<li><a href="#%E4%B8%80-%E5%89%8D%E8%A8%80">一、前言</a></li>
<li><a href="#%E4%BA%8C-%E6%B3%A8%E8%A7%A3%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5">二、注解的基本概念</a>
<ul>
<li><a href="#1-%E6%B3%A8%E8%A7%A3%E5%AE%9A%E4%B9%89">1. 注解定义</a></li>
<li><a href="#2-%E9%99%90%E5%AE%9A%E6%A0%87%E6%B3%A8%E5%AF%B9%E8%B1%A1target">2. 限定标注对象<code>@Target</code></a></li>
<li><a href="#3-%E6%8C%87%E5%AE%9A%E4%BD%9C%E7%94%A8%E6%97%B6%E6%9C%BA">3. 指定作用时机</a></li>
<li><a href="#4-%E6%B7%BB%E5%8A%A0%E5%8F%82%E6%95%B0">4. 添加参数</a></li>
<li><a href="#5-%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8">5. 注解使用</a></li>
<li><a href="#6-%E6%98%8E%E7%A1%AE%E6%B3%A8%E8%A7%A3%E7%9A%84%E6%A0%87%E6%B3%A8%E5%AF%B9%E8%B1%A1">6. 明确注解的标注对象</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89-%E5%86%85%E7%BD%AE%E6%B3%A8%E8%A7%A3">三、内置注解</a>
<ul>
<li><a href="#1-%E5%85%83%E6%B3%A8%E8%A7%A3">1. 元注解</a>
<ul>
<li><a href="#1-target">1 <code>@Target</code></a></li>
<li><a href="#2-retention">2. <code>@Retention</code></a></li>
</ul>
</li>
<li><a href="#2-%E6%A0%87%E5%87%86%E5%BA%93%E9%80%9A%E7%94%A8%E6%B3%A8%E8%A7%A3">2. 标准库通用注解</a>
<ul>
<li><a href="#1-metadata">1. <code>@Metadata</code></a></li>
<li><a href="#2-unsafevariance">2. <code>@UnsafeVariance</code></a></li>
<li><a href="#3-suppress">3. <code>@Suppress</code></a></li>
</ul>
</li>
<li><a href="#3-%E4%B8%8Ejava%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%BA%A4%E4%BA%92%E7%9A%84%E6%B3%A8%E8%A7%A3">3. 与<code>Java</code>虚拟机交互的注解</a>
<ul>
<li><a href="#1-jvmfield">1. <code>@JvmField</code></a></li>
<li><a href="#2-jvmname">2. <code>@JvmName</code></a></li>
<li><a href="#3-jvmmultifileclass">3. <code>@JvmMultifileClass</code></a></li>
<li><a href="#4-jvmoverloads">4. <code>@JvmOverloads</code></a></li>
<li><a href="#5-jvmstatic">5. <code>@JvmStatic</code></a></li>
<li><a href="#6-synchronized">6. <code>@Synchronized</code></a></li>
<li><a href="#7-volatile">7. <code>@Volatile</code></a></li>
<li><a href="#8-throws">8. <code>@Throws</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%9B%9B-%E7%A4%BA%E4%BE%8B-%E4%BB%BF-retrofit%E5%8F%8D%E5%B0%84%E8%AF%BB%E5%8F%96%E6%B3%A8%E8%A7%A3%E8%AF%B7%E6%B1%82%E7%BD%91%E7%BB%9C">四、 示例 – 仿 <code>Retrofit</code>反射读取注解请求网络</a>
<ul>
<li><a href="#1-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%BA%9B%E9%9C%80%E8%A6%81%E7%9A%84%E6%B3%A8%E8%A7%A3">1. 创建一些需要的注解</a></li>
<li><a href="#2-%E5%88%9B%E5%BB%BA%E8%A7%A3%E6%9E%90%E5%8D%95%E4%BE%8Bretroapi">2. 创建解析单例<code>RetroApi</code></a></li>
<li><a href="#3-%E6%B5%8B%E8%AF%95%E5%8F%8D%E5%B0%84%E8%AF%BB%E5%8F%96%E6%B3%A8%E8%A7%A3%E8%AF%B7%E6%B1%82%E7%BD%91%E7%BB%9C%E5%8A%9F%E8%83%BD">3. 测试反射读取注解请求网络功能</a></li>
</ul>
</li>
<li><a href="#%E4%BA%94-%E7%A4%BA%E4%BE%8B-%E6%B3%A8%E8%A7%A3%E5%8A%A0%E6%8C%81%E5%8F%8D%E5%B0%84%E7%89%88model%E6%98%A0%E5%B0%84">五、示例 – 注解加持反射版<code>Model</code>映射</a>
<ul>
<li><a href="#1-%E5%88%9B%E5%BB%BA%E6%94%AF%E6%8C%81%E5%8D%95%E4%B8%AA%E5%B1%9E%E6%80%A7%E5%88%AB%E5%90%8D%E7%9A%84%E6%B3%A8%E8%A7%A3fildname">1. 创建支持单个属性别名的注解<code>FildName</code></a></li>
<li><a href="#2-%E5%88%9B%E5%BB%BA%E6%94%AF%E6%8C%81%E6%95%B0%E6%8D%AE%E7%B1%BB%E7%9A%84%E6%B3%A8%E8%A7%A3mappingstrategy">2. 创建支持数据类的注解<code>MappingStrategy</code></a></li>
</ul>
</li>
<li><a href="#%E5%85%AD-%E7%A4%BA%E4%BE%8B-%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8%E7%89%88-model-%E6%98%A0%E5%B0%84">六、 示例 – 注解处理器版 <code>Model</code> 映射</a>
<ul>
<li><a href="#1-%E7%AE%80%E8%BF%B0java%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B">1. 简述<code>java</code>编译过程</a></li>
<li><a href="#2-%E5%BC%80%E6%BA%90%E5%BA%93kotlinpoet">2. 开源库<code>KotlinPoet</code></a></li>
<li><a href="#3-%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8abstractprocessor">3. 注解处理器<code>AbstractProcessor</code></a>
<ul>
<li><a href="#1-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8">1. 自定义注解处理器</a></li>
<li><a href="#2-%E5%A3%B0%E6%98%8E%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8">2. 声明自定义注解处理器</a></li>
</ul>
</li>
<li><a href="#4-%E6%B3%A8%E8%A7%A3%E8%A7%A3%E6%9E%90%E5%99%A8element">4. 注解解析器<code>Element</code></a></li>
<li><a href="#5-%E5%AE%9E%E7%8E%B0%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8%E7%89%88-model-%E6%98%A0%E5%B0%84">5. 实现注解处理器版 <code>Model</code> 映射</a>
<ul>
<li><a href="#1-%E5%88%9B%E5%BB%BA%E6%B3%A8%E8%A7%A3">1. 创建注解</a></li>
<li><a href="#2-%E5%88%9B%E5%BB%BA%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8">2. 创建注解处理器</a>
<ul>
<li><a href="#1-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96%E5%8C%85">1. 添加依赖包</a></li>
<li><a href="#2-%E5%88%9B%E5%BB%BA%E5%A4%84%E7%90%86%E5%99%A8">2. 创建处理器</a></li>
<li><a href="#3-%E6%B7%BB%E5%8A%A0%E5%A4%84%E7%90%86%E5%99%A8%E5%A3%B0%E6%98%8E">3. 添加处理器声明</a></li>
</ul>
</li>
<li><a href="#3-%E6%B5%8B%E8%AF%95%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8">3. 测试注解处理器</a>
<ul>
<li><a href="#1-buildgradlekts%E9%85%8D%E7%BD%AE">1. <code>build.gradle.kts</code>配置</a></li>
<li><a href="#2-%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6">2. 创建测试文件</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E4%B8%83-kotlin%E7%BC%96%E8%AF%91%E5%99%A8%E6%8F%92%E4%BB%B6">七、<code>Kotlin</code>编译器插件</a>
<ul>
<li><a href="#1-%E7%BC%96%E8%AF%91%E5%99%A8%E6%8F%92%E4%BB%B6%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6">1. 编译器插件工作机制</a></li>
<li><a href="#2-allopen%E6%8F%92%E4%BB%B6">2. <code>AllOpen</code>插件</a>
<ul>
<li><a href="#1-allopen%E6%8F%92%E4%BB%B6%E4%BB%8B%E7%BB%8D">1. <code>AllOpen</code>插件介绍</a></li>
<li><a href="#2-allopen%E6%8F%92%E4%BB%B6%E6%BA%90%E7%A0%81">2. <code>AllOpen</code>插件源码</a></li>
</ul>
</li>
<li><a href="#3-noarg%E6%8F%92%E4%BB%B6">3. <code>NoArg</code>插件</a>
<ul>
<li><a href="#1-noarg%E6%8F%92%E4%BB%B6%E4%BB%8B%E7%BB%8D">1. <code>NoArg</code>插件介绍</a></li>
<li><a href="#2-noarg%E6%8F%92%E4%BB%B6%E6%BA%90%E7%A0%81">2. <code>NoArg</code>插件源码</a>
<ul>
<li><a href="#1-noarg-gradle%E5%85%B3%E9%94%AE%E6%BA%90%E7%A0%81">1. <code>NoArg-Gradle</code>关键源码</a></li>
<li><a href="#2-noarg-intellij%E5%85%B3%E9%94%AE%E6%BA%90%E7%A0%81">2. <code>NoArg-Intellij</code>关键源码</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-%E5%85%B6%E5%AE%83%E5%AE%9E%E7%94%A8%E6%8F%92%E4%BB%B6">4. 其它实用插件</a></li>
<li><a href="#5-%E6%80%BB%E7%BB%93">5. 总结</a></li>
</ul>
</li>
<li><a href="#%E5%85%AB-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">八、 参考文章</a></li>
</ul>
<!-- tocstop -->
</div>
<h1><a href="#一-前言" class="header-anchor">#</a><span id="一-前言">一、前言</span></h1>
<ol>
<li>本文主要讲述<strong>Kotlin 注解</strong></li>
<li><em>本文是对<a target="_blank" rel="noopener" href="https://github.com/enbandari">Bennyhuo老师</a>讲解的<code>Kotlin</code>系列视频的总结笔记</em></li>
<li><strong>Kotlin官网：<a target="_blank" rel="noopener" href="https://kotlinlang.org/">https://kotlinlang.org/</a></strong></li>
<li><strong>Kotlin中文官网：<a target="_blank" rel="noopener" href="https://www.kotlincn.net/">https://www.kotlincn.net/</a></strong></li>
<li><strong>Kotlin源码：<a target="_blank" rel="noopener" href="https://github.com/JetBrains/kotlin">https://github.com/JetBrains/kotlin</a></strong></li>
<li>Kotlin 学习系列文章：
<ul>
<li>
<a href="/2020/12/07/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%B8%80/" title="Kotlin学习系列一：内置类型">kotlin学习系列一：内置类型</a>
</li>
<li>
<a href="/2020/12/15/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%BA%8C/" title="Kotlin学习系列二：类与接口初解">kotlin学习系列二：类与接口初解</a>
</li>
<li>
<a href="/2021/01/15/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%B8%89/" title="Kotlin学习系列三：表达式">kotlin学习系列三：表达式</a>
</li>
<li>
<a href="/2021/01/22/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%9B%9B/" title="Kotlin学习系列四：函数进阶">kotlin学习系列四：函数进阶</a>
</li>
<li>
<a href="/2021/02/02/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%BA%94/" title="Kotlin学习系列五：类型进阶">kotlin学习系列五：类型进阶</a>
</li>
<li>
<a href="/2021/03/08/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%85%AD/" title="kotlin学习系列六：泛型">kotlin学习系列六：泛型</a>
</li>
<li>
<a href="/2021/03/15/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%B8%83/" title="kotlin学习系列七：反射">kotlin学习系列七：反射</a>
</li>
<li>
<a href="/2021/04/15/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%B9%9D/" title="kotlin学习系列九：协程一">kotlin学习系列九：协程初解</a>
</li>
<li>
<a href="/2021/04/15/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%8D%81/" title="kotlin学习系列十：协程二">kotlin学习系列十：协程进阶</a>
</li>
<li>
<a href="/2021/04/15/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%8D%81%E4%B8%80/" title="kotlin学习系列十一：协程三">kotlin学习系列十一：协程应用</a>
</li>
</ul>
</li>
</ol>
<h1><a href="#二-注解的基本概念" class="header-anchor">#</a><span id="二-注解的基本概念">二、注解的基本概念</span></h1>
<p><strong>注解</strong> 实际上就是一种代码标签，它作用的对象是代码。实际上，注解几乎无处不在，比如说，经常能在<code>Kotlin</code>标准库当中看见“<code>@Deprecated</code>&quot; 这样的注解，它代表了被标注的代码“已废弃”。在 <code>Java</code> 中，最常见的是 “<code>@Override</code>&quot; 这个注解，它代表了重写。</p>
<p><strong>注解</strong> 可以给特定的注解代码标注一些额外的信息。然而这些信息可以选择不同保留时期，比如源码期、编译期、运行期。然后在不同时期，可以通过某种方式获取标签的信息来处理实际的代码逻辑，这种方式常常就是我们所说的 <strong>反射</strong>。</p>
<p>总结如下：</p>
<ol>
<li>注解是对程序的附加信息说明，也就是程序代码的一种补充</li>
<li>注解可以对类、函数、函数参数、属性等做标注</li>
<li>注解的信息可用于源码级、编译期、运行时</li>
</ol>
<h2><a href="#1-注解定义" class="header-anchor">#</a><span id="1-注解定义">1. 注解定义</span></h2>
<p><code>Kotlin</code> 的源代码中，提供了很多内置的注解，比如<code>@Deprecated</code>、<code>@JvmStatic</code>、<code>@JvmOverloads</code>等等。除了<code>Kotlin</code>默认就有的注解以外，我们也可以定义自己的注解。</p>
<p>定义注解类使用关键字 <strong><code>annotation</code></strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">State</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> State &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li><code>java</code>中注解通过<code>@interface</code>关键字进行定义，它和接口声明类似，只不过在前面多加<code>@</code></li>
<li><code>kotlin</code>中注解和一般类的声明很类似，只是在<code>class</code>前面加上了<code>annotation</code>修饰符</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Target(CLASS, FUNCTION, PROPERTY, ANNOTATION_CLASS, CONSTRUCTOR, PROPERTY_SETTER, PROPERTY_GETTER, TYPEALIAS)</span></span><br><span class="line"><span class="meta">@MustBeDocumented</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">Deprecated</span>(</span><br><span class="line">    <span class="keyword">val</span> message: String,</span><br><span class="line">    <span class="keyword">val</span> replaceWith: ReplaceWith = ReplaceWith(<span class="string">&quot;&quot;</span>),</span><br><span class="line">    <span class="keyword">val</span> level: DeprecationLevel = DeprecationLevel.WARNING</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>从上面的代码里，我们可以看到，<code>@Deprecated</code> 这个注解的定义上面，还有其他的注解 <code>@Target</code>、<code>@MustBeDocumented</code>。这样的注解，我们叫做元注解，即它本身是注解的同时，还可以用来修饰其他注解。</p>
<p><code>Kotlin</code> 常见的元注解有四个：</p>
<ul>
<li><code>@Target</code>，这个注解是指定了被修饰的注解都可以用在什么地方，也就是目标；</li>
<li><code>@Retention</code>，这个注解是指定了被修饰的注解是不是编译后可见、是不是运行时可见，也就是保留位置；</li>
<li><code>@Repeatable</code>，这个注解是允许我们在同一个地方，多次使用相同的被修饰的注解，使用场景比较少；</li>
<li><code>@MustBeDocumented</code>，指定被修饰的注解应该包含在生成的 <code>API</code> 文档中显示，这个注解一般用于 <code>SDK</code> 当中。</li>
</ul>
<p>这里，需要注意的是 <code>Target</code> 和 <code>Retention</code> 的取值</p>
<h2><a href="#2-限定标注对象target" class="header-anchor">#</a><span id="2-限定标注对象target">2. 限定标注对象<code>@Target</code></span></h2>
<p>定义注解类时，限定定义的注解的标注对象使用 <strong>注解<code>@Target</code></strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Target(CLASS, FUNCTION, PROPERTY, ANNOTATION_CLASS, CONSTRUCTOR, PROPERTY_SETTER, PROPERTY_GETTER, TYPEALIAS)</span></span><br><span class="line"><span class="meta">@MustBeDocumented</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">Deprecated</span>(</span><br><span class="line">    <span class="keyword">val</span> message: String,</span><br><span class="line">    <span class="keyword">val</span> replaceWith: ReplaceWith = ReplaceWith(<span class="string">&quot;&quot;</span>),</span><br><span class="line">    <span class="keyword">val</span> level: DeprecationLevel = DeprecationLevel.WARNING</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li><code>Target</code>常用的范围有：
<ol>
<li><code>CLASS</code>：用于类、接口、单例</li>
<li><code>CONSTRUCTOR</code>：用于主构造器或副构造器</li>
<li><code>PROPERTY</code>：用于属性</li>
<li><code>FUNCTION</code>：用于函数，不包括构造器</li>
</ol>
</li>
<li>注意<code>Target</code>和<code>AnnotationTarget</code>都是包<code>kotlin.annotation</code>下的类</li>
</ol>
<h2><a href="#3-指定作用时机" class="header-anchor">#</a><span id="3-指定作用时机">3. 指定作用时机</span></h2>
<p>定义注解类时，指定作用时机使用 <strong>注解<code>@Retention</code></strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(AnnotationRetention.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(AnnotationTarget.CLASS)</span></span><br><span class="line"><span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">State</span></span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>如上所示，定义的注解<code>State</code>，只能标注在类、接口、单例上，同时指定在运行时再去解释注解</li>
<li>时机范围：
<ol>
<li><code>SOURCE</code>：代表这个注解在编译器处理完之后就被抛弃，这意味着它的信息仅存在于编译器处理期间，不会存到<code>.class</code>文件中</li>
<li><code>BINARY</code>：对应<code>Java</code>中的<code>CLASS</code>，代表编译器将注解存储于类对应的<code>.class</code>文件中，但是在运行时不能通过反射读取，<strong>在<code>Java</code>中这是<code>Annotation</code>的默认行为</strong></li>
<li><code>RUNTIME</code>：代表编译器将注解存储于<code>.class</code>文件中，并且 <strong>可由反射获取</strong>，由于<code>Kotlin</code>的语言特性，<strong>它是<code>Kotlin</code>中的默认策略</strong></li>
</ol>
</li>
</ol>
<h2><a href="#4-添加参数" class="header-anchor">#</a><span id="4-添加参数">4. 添加参数</span></h2>
<p>可以为注解类添加参数，与一般类添加主构造器参数一致</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(AnnotationRetention.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(AnnotationTarget.CLASS)</span></span><br><span class="line"><span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">State</span>(<span class="keyword">val</span> status:String)</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>注解类的参数类型有限制只能是如下类型：基本类型、<code>KClass</code>、枚举、其他注解</li>
<li>这些类型都是在编译期能确定值的类型</li>
<li>在前几节展示的注解 <code>@Deprecated</code> 类当中包含了包含了如下成员：
<ul>
<li><code>message</code> 代表了废弃的提示信息；</li>
<li><code>replaceWith</code> 代表了应该用什么来替代废弃的部分；</li>
<li><code>level</code> 代表警告的程度，分别是 <code>WARNING</code>、<code>ERROR</code>、<code>HIDDEN</code>。</li>
</ul>
</li>
</ol>
<h2><a href="#5-注解使用" class="header-anchor">#</a><span id="5-注解使用">5. 注解使用</span></h2>
<p>直接在对应的限定对象上添加注解即可</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@State(<span class="string">&quot;ready&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Start</span></span><br></pre></td></tr></table></figure>
<h2><a href="#6-明确注解的标注对象" class="header-anchor">#</a><span id="6-明确注解的标注对象">6. 明确注解的标注对象</span></h2>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@get:JvmName</span>(<span class="string">&quot;getStudentName&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> name:String = <span class="string">&quot;Lee&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>如上定义了一个属性<code>name</code>，而注解<code>@get:JvmName(&quot;getStudentName&quot;)</code>作用是将<code>name</code>的<code>getter</code>方法名字指定为<code>getStudentName</code></li>
<li>变更名字的操作还可以指定为<code>receiver</code>、<code>get</code>、<code>file</code>等</li>
</ol>
<h1><a href="#三-内置注解" class="header-anchor">#</a><span id="三-内置注解">三、内置注解</span></h1>
<h2><a href="#1-元注解" class="header-anchor">#</a><span id="1-元注解">1. 元注解</span></h2>
<p><strong>元注解</strong> 是为其他注解进行说明的注解，当自定义一个新的注解类型时，其中可以使用元注解。元注解位于<code>kotlin.annotation.*</code>包下</p>
<h3><a href="#1-target" class="header-anchor">#</a><span id="1-target">1 <code>@Target</code></span></h3>
<p><code>@Target</code> 用来 <strong>指定一个新注解的使用目标</strong>。<br>
<code>@Target</code> 注解有一个 <code>allowedTargets</code> 属性，该属性用来设置注解的使用目标，<code>allowedTargets</code> 是 <code>kotlin.annotation.AnnotationTarget</code> 枚举类型。<br>
<code>AnnotationTarget</code>描述 <code>Kotlin</code> 代码中可以被注解的元素类型，它有 <strong>15</strong> 个枚举常量。如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//源码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="keyword">class</span> <span class="title class_">AnnotationTarget</span> &#123;</span><br><span class="line">    <span class="comment">// 类、接口、object、注解类</span></span><br><span class="line">    CLASS,</span><br><span class="line">    <span class="comment">// 注解类</span></span><br><span class="line">    ANNOTATION_CLASS,</span><br><span class="line">    <span class="comment">// 泛型参数</span></span><br><span class="line">    TYPE_PARAMETER,</span><br><span class="line">    <span class="comment">// 属性</span></span><br><span class="line">    PROPERTY,</span><br><span class="line">    <span class="comment">// 字段、幕后字段</span></span><br><span class="line">    FIELD,</span><br><span class="line">    <span class="comment">// 局部变量</span></span><br><span class="line">    LOCAL_VARIABLE,</span><br><span class="line">    <span class="comment">// 函数参数</span></span><br><span class="line">    VALUE_PARAMETER,</span><br><span class="line">    <span class="comment">// 构造器</span></span><br><span class="line">    CONSTRUCTOR,</span><br><span class="line">    <span class="comment">// 函数</span></span><br><span class="line">    FUNCTION,</span><br><span class="line">    <span class="comment">// 属性的getter</span></span><br><span class="line">    PROPERTY_GETTER,</span><br><span class="line">    <span class="comment">// 属性的setter</span></span><br><span class="line">    PROPERTY_SETTER,</span><br><span class="line">    <span class="comment">// 类型</span></span><br><span class="line">    TYPE,</span><br><span class="line">    <span class="comment">// 表达式</span></span><br><span class="line">    EXPRESSION,</span><br><span class="line">    <span class="comment">// 文件</span></span><br><span class="line">    FILE,</span><br><span class="line">    <span class="comment">// 类型别名</span></span><br><span class="line">    TYPEALIAS</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>常量</th>
<th>使用目标</th>
</tr>
</thead>
<tbody>
<tr>
<td>CLASS</td>
<td>类、接口、对象声明和注解类声明</td>
</tr>
<tr>
<td>ANNOTATION_CLASS</td>
<td>其他注解类型声明</td>
</tr>
<tr>
<td>TYPE_PARAMERTER</td>
<td>用于泛型中类型参数声明</td>
</tr>
<tr>
<td>PROPERTY</td>
<td>属性声明</td>
</tr>
<tr>
<td>FIELD</td>
<td>字段声明，包括属性的支持字段</td>
</tr>
<tr>
<td>LOCAL_VARIABLE</td>
<td>局部变量声明</td>
</tr>
<tr>
<td>VALUE_PARAMETER</td>
<td>用于函数或构造函数参数值声明</td>
</tr>
<tr>
<td>CONSTRUCTOR</td>
<td>用于构造函数声明</td>
</tr>
<tr>
<td>FUNCTION</td>
<td>用于函数声明，不包括构造函数</td>
</tr>
<tr>
<td>PROPERTY_GETTER</td>
<td>只用于属性的 getter 访问器声明</td>
</tr>
<tr>
<td>PROPERTY_SETTER</td>
<td>只用于属性的 setter 访问器声明</td>
</tr>
<tr>
<td>TYPE</td>
<td>类型使用</td>
</tr>
<tr>
<td>EXPRESSION</td>
<td>任何表达式</td>
</tr>
<tr>
<td>FILE</td>
<td>文件</td>
</tr>
<tr>
<td>TYPEALIAS</td>
<td>类型别名</td>
</tr>
</tbody>
</table>
<h3><a href="#2-retention" class="header-anchor">#</a><span id="2-retention">2. <code>@Retention</code></span></h3>
<p><code>@Retention</code> 用来指定一个新注解的有效范围。<br>
<code>@Retention</code> 注解有一个 <code>value</code> 属性，该属性用来设置保留期，<code>value</code> 是 <code>kotlin.annotation.AnnotationRetention</code> 枚举类型。<br>
<code>AnnotationRetention</code> 描述注解保留期，它有 <strong>3</strong> 个常量，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//源码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="keyword">class</span> <span class="title class_">AnnotationRetention</span> &#123;</span><br><span class="line">    <span class="comment">// 注解只存在于源代码，编译后不可见</span></span><br><span class="line">    SOURCE,</span><br><span class="line">    <span class="comment">// 注解编译后可见，运行时不可见</span></span><br><span class="line">    BINARY,</span><br><span class="line">    <span class="comment">// 编译后可见，运行时可见</span></span><br><span class="line">    RUNTIME</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>常量</th>
<th>保留期</th>
</tr>
</thead>
<tbody>
<tr>
<td>SOURCE</td>
<td>只适用于源代码文件中，此范围最小</td>
</tr>
<tr>
<td>BINARY</td>
<td>编译器把注解信息记录在编译之后的二进制文件中，对于反射是不可见的，此范围居中</td>
</tr>
<tr>
<td>RUNTIME</td>
<td>编译器把注解信息记录在编译之后的二进制文件中，对于反射是可见的，此范围最大，这是默认保留期</td>
</tr>
</tbody>
</table>
<h2><a href="#2-标准库通用注解" class="header-anchor">#</a><span id="2-标准库通用注解">2. 标准库通用注解</span></h2>
<p><strong>标准库通用注解</strong> 位于<code>kotlin.*</code></p>
<h3><a href="#1-metadata" class="header-anchor">#</a><span id="1-metadata">1. <code>@Metadata</code></span></h3>
<p><code>Java</code> 反射对于 <code>Kotlin</code> 的很多特性都无法访问和识别，而<code>Kotlin</code> 的反射可以访问和识别，就是因为注解<code>@Metadata</code></p>
<p><code>@Metadata</code>会由<code>Kotlin</code>的编译器添加到由编译器生成的<code>class</code>文件中，它可以被编译器和反射读取。</p>
<p><code>Kotlin</code> 反射过程中，注解的内容解析之后会实例化一个叫做 <code>KotlinClassHeader</code> 的类。下表为注解中的属性与类中成员对应关系：</p>
<p>官网源码：<a target="_blank" rel="noopener" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-metadata/">https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-metadata/</a></p>
<table>
<thead>
<tr>
<th>Metadata</th>
<th>KotlinClassHeader</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>k</td>
<td>kind</td>
<td>注解标注目标类型，例如类、文件等等</td>
</tr>
<tr>
<td>mv</td>
<td>metadataVersion</td>
<td>该元数据的版本</td>
</tr>
<tr>
<td>bv</td>
<td>bytecodeVersion</td>
<td>字节码版本</td>
</tr>
<tr>
<td>d1</td>
<td>data</td>
<td>自定义元数据</td>
</tr>
<tr>
<td>d2</td>
<td>strings</td>
<td>自定义元数据补充字段</td>
</tr>
<tr>
<td>xs</td>
<td>extraString</td>
<td>附加字段</td>
</tr>
<tr>
<td>xi</td>
<td>extraInt</td>
<td>1.1 加入的附加标记，标记类文件的来源类型</td>
</tr>
</tbody>
</table>
<p><strong>说明：</strong></p>
<p><strong>d1：</strong> 存储了自定义格式的元数据，官方声称针对不同的类型格式不定，甚至可以为空，研究发现目前采用 <strong>Protobuf</strong> 进行序列化存储。<strong>这些数据会被 <code>Kotlin</code> 反射读取，是反射的一个非常重要的数据来源</strong>。其中包含不限于 <strong>类型、函数、属性等的可见性、类型是否可空、函数是否为 suspend</strong>等等信息。</p>
<p><strong>d2：</strong> 存储明文字符串字面量，主要存储 <code>Jvm</code> 签名等信息。之所以这样设计，主要是为了将这些字符串在运行时直接加载到虚拟机内存的常量池中予以复用，减少内存开销。</p>
<h3><a href="#2-unsafevariance" class="header-anchor">#</a><span id="2-unsafevariance">2. <code>@UnsafeVariance</code></span></h3>
<p>该注解用于泛型破除型变限制</p>
<p><strong>源码如下：</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(TYPE)</span></span><br><span class="line"><span class="meta">@Retention(SOURCE)</span></span><br><span class="line"><span class="meta">@MustBeDocumented</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">UnsafeVariance</span></span><br></pre></td></tr></table></figure>
<h3><a href="#3-suppress" class="header-anchor">#</a><span id="3-suppress">3. <code>@Suppress</code></span></h3>
<p>在 <code>Java</code> 中，使用注解 <code>@SuppressWarnings(&quot;xxx&quot;)</code> 消除一些编译时的警告<br>
在 <code>Kotlin</code> 中，使用内置的 <code>@Suppress(&quot;xxx&quot;)</code> 消除一些编译时的警告</p>
<p>使用时，将警告类型作为参数传入注解入参</p>
<p><strong>示例如下：</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> map: Map&lt;Any,Any&gt; = emptyMap()</span><br><span class="line"></span><br><span class="line"><span class="meta">@Suppress(<span class="string">&quot;UNCHECKED_CAST&quot;</span>)</span></span><br><span class="line">map <span class="keyword">as</span> Map&lt;String, Any&gt;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>如果不添加注解，则会有警告提示：<code>Unchecked cast: Map&lt;Any, Any&gt; to Map&lt;String, Any&gt;</code>，加上注解后警告消失</li>
</ol>
<p><strong>注解的源码如下：</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(CLASS, ANNOTATION_CLASS, PROPERTY, FIELD, LOCAL_VARIABLE, VALUE_PARAMETER,</span></span><br><span class="line"><span class="meta">        CONSTRUCTOR, FUNCTION, PROPERTY_GETTER, PROPERTY_SETTER, TYPE, EXPRESSION, FILE, TYPEALIAS)</span></span><br><span class="line"><span class="meta">@Retention(SOURCE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">Suppress</span>(<span class="keyword">vararg</span> <span class="keyword">val</span> names: String)</span><br></pre></td></tr></table></figure>
<h2><a href="#3-与java虚拟机交互的注解" class="header-anchor">#</a><span id="3-与java虚拟机交互的注解">3. 与<code>Java</code>虚拟机交互的注解</span></h2>
<p>用于与<code>Java</code>虚拟机交互的注解，位于<code>kotlin.jvm.*</code></p>
<p>官网源码：<a target="_blank" rel="noopener" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.jvm/">https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.jvm/</a><br>
参考文章：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/eb091dd229f6">正确使用Kotlin注解，兼容Java代码</a></p>
<h3><a href="#1-jvmfield" class="header-anchor">#</a><span id="1-jvmfield">1. <code>@JvmField</code></span></h3>
<p>使<code>Kotlin</code>编译器不再对该字段生成<code>getter/setter</code>，且其作用域为<code>public</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(<span class="keyword">var</span> name:String, <span class="keyword">var</span> age:<span class="built_in">Int</span>)</span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(<span class="meta">@NotNull</span> String var1)</span> &#123;</span><br><span class="line">      Intrinsics.checkNotNullParameter(var1, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">      <span class="built_in">this</span>.name = var1;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.age;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> var1)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.age = var1;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(<span class="meta">@NotNull</span> String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.name = name;</span><br><span class="line">      <span class="built_in">this</span>.age = age;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为属性添加注解<code>@JvmField</code>如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(<span class="meta">@JvmField</span> <span class="keyword">var</span> name:String, <span class="keyword">var</span> age:<span class="built_in">Int</span>)</span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">   <span class="meta">@JvmField</span></span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">public</span> String name;</span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.age;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> var1)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.age = var1;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(<span class="meta">@NotNull</span> String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.name = name;</span><br><span class="line">      <span class="built_in">this</span>.age = age;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>可以看到添加注解<code>JvmField</code>后，<code>name</code>属性没有了<code>getter/setter</code>，但是作用域从<code>private</code>变为了<code>public</code></li>
</ol>
<h3><a href="#2-jvmname" class="header-anchor">#</a><span id="2-jvmname">2. <code>@JvmName</code></span></h3>
<p>告诉使<code>Kotlin</code>编译器生成的<code>Java</code>类或者方法的名称<br>
<strong>注意：该注解只能用于函数、属性的 <code>getter/setter</code>、文件</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ltt.projectcollection.kotlin.annotationlab</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> kotlinField: <span class="built_in">Int</span> = <span class="number">2</span></span><br><span class="line">    <span class="keyword">set</span>(value) &#123;</span><br><span class="line">        field = value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> field</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">kotlinFunction</span><span class="params">()</span></span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    kotlinFunction()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// KotlinAnnotationLabKt.java</span></span><br><span class="line"><span class="keyword">package</span> cn.ltt.projectcollection.kotlin.annotationlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">KotlinAnnotationLabKt</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">kotlinField</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getKotlinField</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> kotlinField;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setKotlinField</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">      kotlinField = value;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">kotlinFunction</span><span class="params">()</span> &#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">      kotlinFunction();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// $FF: synthetic method</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] var0)</span> &#123;</span><br><span class="line">      main();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为文件、函数、属性的<code>getter/setter</code>添加注解<code>@JvmName</code>如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改生成文件名</span></span><br><span class="line"><span class="meta">@file:JvmName</span>(<span class="string">&quot;JavaClassLab&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.ltt.projectcollection.kotlin.annotationlab</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> kotlinField: <span class="built_in">Int</span> = <span class="number">2</span></span><br><span class="line">    <span class="comment">//修改属性的set方法名</span></span><br><span class="line">    <span class="meta">@JvmName(<span class="string">&quot;setJavaField&quot;</span>)</span></span><br><span class="line">    <span class="keyword">set</span>(value) &#123;</span><br><span class="line">        field = value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改属性的get方法名</span></span><br><span class="line">    <span class="meta">@JvmName(<span class="string">&quot;getJavaField&quot;</span>)</span></span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> field</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改普通的方法名</span></span><br><span class="line"><span class="meta">@JvmName(<span class="string">&quot;JavaFunction&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">kotlinFunction</span><span class="params">()</span></span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    kotlinFunction()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JavaClassLab.java</span></span><br><span class="line"><span class="keyword">package</span> cn.ltt.projectcollection.kotlin.annotationlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.JvmName;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JvmName(</span></span><br><span class="line"><span class="meta">   name = &quot;JavaClassLab&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">JavaClassLab</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">kotlinField</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@JvmName(</span></span><br><span class="line"><span class="meta">      name = &quot;getJavaField&quot;</span></span><br><span class="line"><span class="meta">   )</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getJavaField</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> kotlinField;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@JvmName(</span></span><br><span class="line"><span class="meta">      name = &quot;setJavaField&quot;</span></span><br><span class="line"><span class="meta">   )</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setJavaField</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">      kotlinField = value;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@JvmName(</span></span><br><span class="line"><span class="meta">      name = &quot;JavaFunction&quot;</span></span><br><span class="line"><span class="meta">   )</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">JavaFunction</span><span class="params">()</span> &#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">      JavaFunction();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>注解<code>@JvmName</code>只能用于函数、属性的 <code>getter/setter</code>、文件</li>
<li><code>Kotlin</code>可以正常使用添加了注解<code>@JvmName</code>的对象，但是编译器会自动替换成<code>@JvmName</code>声明的名字</li>
<li><code>Java</code>直接使用<code>@JvmName</code>修改后的名字，由此可以用来应对各种类名修改以后的兼容性问题</li>
</ol>
<h3><a href="#3-jvmmultifileclass" class="header-anchor">#</a><span id="3-jvmmultifileclass">3. <code>@JvmMultifileClass</code></span></h3>
<p><code>Kotlin</code>编译器会将多个文件生成一个类，该文件具有在此文件中 <strong>声明的顶级函数和属性</strong> 作为其中的一部分，<code>JvmName</code>注解提供了相应的多文件的名称</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MultiClassA.kt</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@file:JvmName</span>(<span class="string">&quot;Utils&quot;</span>)</span><br><span class="line"><span class="meta">@file:JvmMultifileClass</span></span><br><span class="line"><span class="keyword">package</span> cn.ltt.projectcollection.kotlin.annotationlab.multiclasstest</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getDeviceId</span><span class="params">()</span></span> : String = <span class="string">&quot;deviceId&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">lateinit</span> <span class="keyword">var</span> id: String</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> DEVICE_ID_DEFAULT = <span class="string">&quot;123&quot;</span></span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils__MultiClassAKt.java</span></span><br><span class="line"><span class="keyword">package</span> cn.ltt.projectcollection.kotlin.annotationlab.multiclasstest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Utils__MultiClassAKt</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String id;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <span class="title function_">getDeviceId</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;deviceId&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">var10000</span> <span class="operator">=</span> id;</span><br><span class="line">      <span class="keyword">return</span> var10000;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="meta">@NotNull</span> String var0)</span> &#123;</span><br><span class="line">      id = var0;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Utils.java</span></span><br><span class="line"><span class="keyword">package</span> cn.ltt.projectcollection.kotlin.annotationlab.multiclasstest;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Utils</span> &#123;</span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEVICE_ID_DEFAULT</span> <span class="operator">=</span> <span class="string">&quot;123&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Utils__MultiClassAKt.getId();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="meta">@NotNull</span> String var0)</span> &#123;</span><br><span class="line">      Utils__MultiClassAKt.setId(var0);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <span class="title function_">getDeviceId</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Utils__MultiClassAKt.getDeviceId();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MultiClassB.kt</span></span><br><span class="line"><span class="meta">@file:JvmName</span>(<span class="string">&quot;Utils&quot;</span>)</span><br><span class="line"><span class="meta">@file:JvmMultifileClass</span></span><br><span class="line"><span class="keyword">package</span> cn.ltt.projectcollection.kotlin.annotationlab.multiclasstest</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getDeviceWidth</span><span class="params">()</span></span> : <span class="built_in">Int</span> = width</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> width: <span class="built_in">Int</span> = <span class="number">333</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> DEVICE_WIDTH_DEFAULT = <span class="number">233</span></span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils__MultiClassBKt.java</span></span><br><span class="line"><span class="keyword">package</span> cn.ltt.projectcollection.kotlin.annotationlab.multiclasstest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Utils__MultiClassBKt</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> <span class="number">333</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getDeviceWidth</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> width;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getWidth</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> width;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setWidth</span><span class="params">(<span class="type">int</span> var0)</span> &#123;</span><br><span class="line">      width = var0;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Utils.java</span></span><br><span class="line"><span class="keyword">package</span> cn.ltt.projectcollection.kotlin.annotationlab.multiclasstest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Utils</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEVICE_WIDTH_DEFAULT</span> <span class="operator">=</span> <span class="number">233</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getWidth</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Utils__MultiClassBKt.getWidth();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setWidth</span><span class="params">(<span class="type">int</span> var0)</span> &#123;</span><br><span class="line">      Utils__MultiClassBKt.setWidth(var0);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getDeviceWidth</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Utils__MultiClassBKt.getDeviceWidth();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>Java</code>调用上述两个文件的属性、函数如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiClassTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Utils.getDeviceId();</span><br><span class="line">        Utils.getDeviceWidth();</span><br><span class="line">        Utils.setId(<span class="string">&quot;111&quot;</span>);</span><br><span class="line">        Utils.getId();</span><br><span class="line">        Utils.getWidth();</span><br><span class="line">        System.out.println(Utils.DEVICE_ID_DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>通过反编译的代码可以看出，添加了<code>@JvmMultifileClass</code>注解，在生成自己的类文件同时还会生成一个由<code>@JvmName</code>提供名字的公共类，然后，两个添加了<code>@JvmMultifileClass</code>注解的<code>Kotlin</code>文件中的顶级函数、属性的都可以在公共类中调用。</li>
<li>即将两个添加了<code>@JvmMultifileClass</code>注解的文件<code>MultiClassA.kt</code>、<code>MultiClassB.kt</code> 合并到了公共类<code>Utils</code>中，注解可以消除我们去手动创建一个公共类，向公共类中添加方法更加灵活和方便</li>
</ol>
<h3><a href="#4-jvmoverloads" class="header-anchor">#</a><span id="4-jvmoverloads">4. <code>@JvmOverloads</code></span></h3>
<p>Kotlin编译器为添加该注解的函数生成替换默认参数值的重载</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">defaultParamFun</span><span class="params">(x:<span class="type">Int</span> = <span class="number">5</span>, y:<span class="type">String</span>, z: <span class="type">Long</span> = <span class="number">0</span>L)</span></span> &#123;</span><br><span class="line">    println(<span class="string">&quot;x:<span class="variable">$x</span>, y:<span class="variable">$y</span>, z: <span class="variable">$z</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">defaultParamFun</span><span class="params">(<span class="type">int</span> x, <span class="meta">@NotNull</span> String y, <span class="type">long</span> z)</span> &#123;</span><br><span class="line">      Intrinsics.checkNotNullParameter(y, <span class="string">&quot;y&quot;</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="string">&quot;x:&quot;</span> + x + <span class="string">&quot;, y:&quot;</span> + y + <span class="string">&quot;, z: &quot;</span> + z;</span><br><span class="line">      <span class="type">boolean</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">      System.out.println(var4);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $FF: synthetic method</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> defaultParamFun$<span class="keyword">default</span>(<span class="type">int</span> var0, String var1, <span class="type">long</span> var2, <span class="type">int</span> var4, Object var5) &#123;</span><br><span class="line">   <span class="keyword">if</span> ((var4 &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">      var0 = <span class="number">5</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> ((var4 &amp; <span class="number">4</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">      var2 = <span class="number">0L</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   defaultParamFun(var0, var1, var2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为函数添加注解<code>@JvmOveerloads</code>如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JvmOverloads</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">defaultParamFun</span><span class="params">(x:<span class="type">Int</span> = <span class="number">5</span>, y:<span class="type">String</span>, z: <span class="type">Long</span> = <span class="number">0</span>L)</span></span> &#123;</span><br><span class="line">    println(<span class="string">&quot;x:<span class="variable">$x</span>, y:<span class="variable">$y</span>, z: <span class="variable">$z</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JvmOverloads</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">defaultParamFun</span><span class="params">(<span class="type">int</span> x, <span class="meta">@NotNull</span> String y, <span class="type">long</span> z)</span> &#123;</span><br><span class="line">   Intrinsics.checkNotNullParameter(y, <span class="string">&quot;y&quot;</span>);</span><br><span class="line">   <span class="type">String</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="string">&quot;x:&quot;</span> + x + <span class="string">&quot;, y:&quot;</span> + y + <span class="string">&quot;, z: &quot;</span> + z;</span><br><span class="line">   <span class="type">boolean</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">   System.out.println(var4);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $FF: synthetic method</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> defaultParamFun$<span class="keyword">default</span>(<span class="type">int</span> var0, String var1, <span class="type">long</span> var2, <span class="type">int</span> var4, Object var5) &#123;</span><br><span class="line">   <span class="keyword">if</span> ((var4 &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">      var0 = <span class="number">5</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> ((var4 &amp; <span class="number">4</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">      var2 = <span class="number">0L</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   defaultParamFun(var0, var1, var2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JvmOverloads</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">defaultParamFun</span><span class="params">(<span class="type">int</span> x, <span class="meta">@NotNull</span> String y)</span> &#123;</span><br><span class="line">   defaultParamFun$<span class="keyword">default</span>(x, y, <span class="number">0L</span>, <span class="number">4</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JvmOverloads</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">defaultParamFun</span><span class="params">(<span class="meta">@NotNull</span> String y)</span> &#123;</span><br><span class="line">   defaultParamFun$<span class="keyword">default</span>(<span class="number">0</span>, y, <span class="number">0L</span>, <span class="number">5</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>可以看到添加了注解 <code>@JvmOverloads</code>的函数会重载多个名字相同，参数不同的函数</li>
<li>该注解应该使用在带默认参数的函数上，由此可以让<code>Java</code>享受到<code>Koltin</code>的 <strong>默认参数</strong>的特性</li>
<li>重载的规则是顺序重载，<strong>只有有默认值的参数会参与重载</strong></li>
</ol>
<h3><a href="#5-jvmstatic" class="header-anchor">#</a><span id="5-jvmstatic">5. <code>@JvmStatic</code></span></h3>
<p>对 <strong>函数</strong>使用该注解，<code>kotlin</code>编译器将生成另一个静态方法<br>
对 <strong>属性</strong>使用该注解，<code>kotlin</code>编译器将生成其他的<code>setter</code>和<code>getter</code>方法<br>
<strong>作用：</strong> 消除<code>Java</code>调用<code>Kotlin</code>的<code>companion object</code>对象时不能直接调用其静态方法和属性的问题<br>
<strong>注意：此注解只能在<code>companion object</code>中使用</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ClassA</span> &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> nameDefault: String = <span class="string">&quot;Lee&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">getName</span><span class="params">()</span></span>: String = <span class="string">&quot;name:<span class="variable">$nameDefault</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ClassA</span> &#123;</span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">nameDefault</span> <span class="operator">=</span> <span class="string">&quot;Lee&quot;</span>;</span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ClassA.<span class="type">Companion</span> <span class="variable">Companion</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassA</span>.Companion((DefaultConstructorMarker)<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Companion</span> &#123;</span><br><span class="line">      <span class="meta">@NotNull</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getNameDefault</span><span class="params">()</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> ClassA.nameDefault;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setNameDefault</span><span class="params">(<span class="meta">@NotNull</span> String var1)</span> &#123;</span><br><span class="line">         Intrinsics.checkNotNullParameter(var1, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">         ClassA.nameDefault = var1;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@NotNull</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">&quot;name:&quot;</span> + ((ClassA.Companion)<span class="built_in">this</span>).getNameDefault();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="title function_">Companion</span><span class="params">()</span> &#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// $FF: synthetic method</span></span><br><span class="line">      <span class="keyword">public</span> <span class="title function_">Companion</span><span class="params">(DefaultConstructorMarker $constructor_marker)</span> &#123;</span><br><span class="line">         <span class="built_in">this</span>();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//未添加注解java调用companion object中的属性函数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">   ClassA.Companion.getName();</span><br><span class="line">   ClassA.Companion.getNameDefault();</span><br><span class="line">   ClassA.Companion.setNameDefault(<span class="string">&quot;Lee2&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>由反编译的代码可以看出，在<code>companion object</code>中定义的函数和属性生成的<code>Java</code>方法也只是在<code>Companion</code>类中。即如果需要调用<code>companion object</code>中定义的函数和属性必须借助<code>Companion</code></li>
</ol>
<p>为属性和函数添加注解<code>@JvmStatic</code>如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ClassA</span> &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="keyword">var</span> nameDefault: String = <span class="string">&quot;Lee&quot;</span></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">getName</span><span class="params">()</span></span>: String = <span class="string">&quot;name:<span class="variable">$nameDefault</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ClassA</span> &#123;</span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">nameDefault</span> <span class="operator">=</span> <span class="string">&quot;Lee&quot;</span>;</span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ClassA.<span class="type">Companion</span> <span class="variable">Companion</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassA</span>.Companion((DefaultConstructorMarker)<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <span class="title function_">getNameDefault</span><span class="params">()</span> &#123;</span><br><span class="line">      ClassA.<span class="type">Companion</span> <span class="variable">var10000</span> <span class="operator">=</span> Companion;</span><br><span class="line">      <span class="keyword">return</span> nameDefault;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setNameDefault</span><span class="params">(<span class="meta">@NotNull</span> String var0)</span> &#123;</span><br><span class="line">      ClassA.<span class="type">Companion</span> <span class="variable">var10000</span> <span class="operator">=</span> Companion;</span><br><span class="line">      nameDefault = var0;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@JvmStatic</span></span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Companion.getName();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Companion</span> &#123;</span><br><span class="line">      <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">      <span class="comment">// $FF: synthetic method</span></span><br><span class="line">      <span class="meta">@JvmStatic</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> getNameDefault$annotations() &#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@NotNull</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getNameDefault</span><span class="params">()</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> ClassA.nameDefault;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setNameDefault</span><span class="params">(<span class="meta">@NotNull</span> String var1)</span> &#123;</span><br><span class="line">         Intrinsics.checkNotNullParameter(var1, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">         ClassA.nameDefault = var1;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@JvmStatic</span></span><br><span class="line">      <span class="meta">@NotNull</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">&quot;name:&quot;</span> + ((ClassA.Companion)<span class="built_in">this</span>).getNameDefault();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="title function_">Companion</span><span class="params">()</span> &#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// $FF: synthetic method</span></span><br><span class="line">      <span class="keyword">public</span> <span class="title function_">Companion</span><span class="params">(DefaultConstructorMarker $constructor_marker)</span> &#123;</span><br><span class="line">         <span class="built_in">this</span>();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">   <span class="comment">//添加注解后java调用companion object中的属性函数</span></span><br><span class="line">   ClassA.getName();</span><br><span class="line">   ClassA.getNameDefault();</span><br><span class="line">   ClassA.setNameDefault(<span class="string">&quot;Lee2&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>可以看到添加了注解 <code>@JvmStatic</code>后的属性和函数都会在伴生对象所在的类中生成各自对应的静态方法，虽然<code>Companio</code>n这个静态内部类还在，但是<code>Java</code>现在就不需要再借助<code>Companion</code>类而可以直接调用对应的静态方法和属性</li>
</ol>
<h3><a href="#6-synchronized" class="header-anchor">#</a><span id="6-synchronized">6. <code>@Synchronized</code></span></h3>
<p><code>Kotlin</code>语言不支持<code>synchronized</code>关键字，使用该注解生成同步方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Synchronized</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>注解<code>@Synchronized</code>只能添加在 <strong>函数、属性的<code>getter/setter</code>方法</strong></li>
<li>设置了该注解的函数编译器生成<code>java</code>方法时会自动添加一个<code>synchronized</code>关键字</li>
</ol>
<h3><a href="#7-volatile" class="header-anchor">#</a><span id="7-volatile">7. <code>@Volatile</code></span></h3>
<p>该注解对应<code>Java</code>端的关键字<code>volatile</code>，功能与其一致</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Volatile</span></span><br><span class="line"><span class="keyword">lateinit</span> <span class="keyword">var</span> name: String</span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">volatile</span> String name;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>注解<code>@Volatile</code>只用于属性</li>
<li>设置了该注解的属性编译器生成<code>java</code>变量时会自动添加一个<code>volatile</code>关键字</li>
</ol>
<h3><a href="#8-throws" class="header-anchor">#</a><span id="8-throws">8. <code>@Throws</code></span></h3>
<p><strong><code>Checked exception</code>:</strong> 继承自 <code>Exception</code> 类。代码需要处理 <code>API</code> 抛出的 <code>checked exception</code>，要么用 <code>catch</code> 语句，要么直接用 <code>throws</code> 语句抛出去。可以理解为 <strong>编译时异常</strong>，不处理编译不能通过。</p>
<p>由于<code>Kotlin</code>语言不支持<code>CE</code><em>(Checked Exception)</em>，为了兼容这种写法，<code>Kotlin</code>语言增加了<code>@Throws</code>注解，该注解的接收一个可变参数，参数类型是多个异常的<code>KClass</code>实例。<code>Kotlin</code>编译器通过读取注解参数，在生成的字节码中自动添加<code>CE</code>声明</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Throws(IllegalAccessException::class)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反编译上述代码<code>class</code>文件后代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>注解只能用于 <strong>函数、属性的<code>getter/setter</code>、构造器</strong>上</li>
</ol>
<h1><a href="#四-示例-仿-retrofit反射读取注解请求网络" class="header-anchor">#</a><span id="四-示例-仿-retrofit反射读取注解请求网络">四、 示例 – 仿 <code>Retrofit</code>反射读取注解请求网络</span></h1>
<h2><a href="#1-创建一些需要的注解" class="header-anchor">#</a><span id="1-创建一些需要的注解">1. 创建一些需要的注解</span></h2>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">User</span>(</span><br><span class="line">    <span class="keyword">var</span> login: String,</span><br><span class="line">    <span class="keyword">var</span> location: String,</span><br><span class="line">    <span class="keyword">var</span> avatar_url: String,</span><br><span class="line">    <span class="keyword">var</span> bio: String)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention(AnnotationRetention.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(AnnotationTarget.CLASS)</span></span><br><span class="line"><span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">Api</span>(<span class="keyword">val</span> url: String)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention(AnnotationRetention.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(AnnotationTarget.FUNCTION)</span></span><br><span class="line"><span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">Get</span>(<span class="keyword">val</span> url: String = <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Api(<span class="string">&quot;https://api.github.com&quot;</span>)</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">GitHubApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Api(<span class="string">&quot;users&quot;</span>)</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Users</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Get(<span class="string">&quot;&#123;name&#125;&quot;</span>)</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(name: <span class="type">String</span>)</span></span>: User</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Get(<span class="string">&quot;&#123;name&#125;/followers&quot;</span>)</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">followers</span><span class="params">(name: <span class="type">String</span>)</span></span>: List&lt;User&gt;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Api(<span class="string">&quot;repos&quot;</span>)</span></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Repos</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Get(<span class="string">&quot;&#123;owner&#125;/&#123;repo&#125;/forks&quot;</span>)</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">forks</span><span class="params">(owner: <span class="type">String</span>, repo: <span class="type">String</span>)</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>定义一个数据类<code>User</code>，用于接收从接口<code>https://api.github.com/users/puppet16</code>返回的数据，分别有登录名 <em>(login)</em>、所在地 <em>(location)</em> 、头像 <em>(avatar_url)</em>、个性签名 <em>(bio)</em></li>
<li><code>https://api.github.com/users/用户名</code>接口可以获取<code>Github</code>网站上某用户的一些公开信息</li>
<li>定义了两个作用于接口上的注解<code>Api</code>、<code>Path</code>:
<ol>
<li><code>Api</code>注解：有一个参数用于保存网络地址的<code>host</code></li>
<li><code>Path</code>注解：有一个参数用于保存网络地址的<code>path</code>路径，参数默认为空串</li>
</ol>
</li>
<li>定义了一个作用于函数上的注解<code>Get</code>,有一个参数用于保存网络地址的</li>
<li>定义一个接口<code>GitHubApi</code>，在该接口定义上添加注解<code>@Api</code>，参数传入 <code>https://api.github.com</code>，在该接口内又定义了接口接口<code>Users</code>，添加注解<code>@Api</code>，传入的是该类的<code>host</code>值：<code>users</code>，该类又定义了两个函数：
<ol>
<li>函数<code>get()</code>，用于获取用户的信息</li>
<li>函数<code>followers()</code>，用于获取助关注用户的用户列表</li>
</ol>
</li>
</ol>
<h2><a href="#2-创建解析单例retroapi" class="header-anchor">#</a><span id="2-创建解析单例retroapi">2. 创建解析单例<code>RetroApi</code></span></h2>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> RetroApi &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> PATH_PATTERN = <span class="string">&quot;&quot;&quot;(\&#123;(\w+)\&#125;)&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> okHttp = OkHttpClient()</span><br><span class="line">    <span class="keyword">val</span> gson = Gson()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> enclosing = &#123;</span><br><span class="line">        cls: Class&lt;*&gt; -&gt;</span><br><span class="line">        <span class="keyword">var</span> currentCls: Class&lt;*&gt;? = cls</span><br><span class="line">        sequence &#123;</span><br><span class="line">            <span class="keyword">while</span>(currentCls != <span class="literal">null</span>)&#123;</span><br><span class="line">                currentCls = currentCls?.also &#123; yield(it) &#125;?.enclosingClass</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T&gt;</span> <span class="title">create</span><span class="params">()</span></span>: T &#123;</span><br><span class="line">        <span class="keyword">val</span> functionMap = T::<span class="keyword">class</span>.functions.map&#123; it.name to it &#125;.toMap()</span><br><span class="line">        <span class="keyword">val</span> interfaces = enclosing(T::<span class="keyword">class</span>.java).takeWhile &#123; it.isInterface &#125;.toList()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> apiPath = interfaces.foldRight(StringBuilder()) &#123;</span><br><span class="line">            clazz, acc -&gt;</span><br><span class="line">            acc.append(clazz.getAnnotation(Api::<span class="keyword">class</span>.java)</span><br><span class="line">                ?.url?.takeIf &#123; it.isNotEmpty() &#125;</span><br><span class="line">                ?:clazz.name).append(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">        &#125;.toString()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(RetroApi.javaClass.classLoader, arrayOf(T::<span class="keyword">class</span>.java)) &#123;</span><br><span class="line">            proxy, method, args -&gt;</span><br><span class="line">            functionMap[method.name]?.takeIf &#123; it.isAbstract &#125;?.let &#123;</span><br><span class="line">                function -&gt;</span><br><span class="line">                <span class="keyword">val</span> parameterMap = function.valueParameters.map &#123;</span><br><span class="line">                    it.name to args[it.index - <span class="number">1</span>]</span><br><span class="line">                &#125;.toMap()</span><br><span class="line"></span><br><span class="line">                <span class="comment">//&#123;name&#125;</span></span><br><span class="line">                <span class="keyword">val</span> endPoint = function.findAnnotation&lt;Get&gt;()!!.url.takeIf &#123; it.isNotEmpty() &#125;?: function.name</span><br><span class="line">                <span class="keyword">val</span> compiledEndPoint = Regex(PATH_PATTERN).findAll(endPoint).map &#123;</span><br><span class="line">                    matchResult -&gt;</span><br><span class="line">                    matchResult.groups[<span class="number">1</span>]!!.range to parameterMap[matchResult.groups[<span class="number">2</span>]!!.value]</span><br><span class="line">                &#125;.fold(endPoint) &#123;</span><br><span class="line">                    acc, pair -&gt;</span><br><span class="line">                    acc.replaceRange(pair.first, pair.second.toString())</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">val</span> url = apiPath + compiledEndPoint</span><br><span class="line">                println(url)</span><br><span class="line"></span><br><span class="line">                okHttp.newCall(Request.Builder().url(url).<span class="keyword">get</span>().build()).execute().body?.charStream()?.use &#123;</span><br><span class="line">                    gson.fromJson(JsonReader(it), method.genericReturnType)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">as</span> T</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>定义一个正则表达式<code>PATH_PATTERN</code>，用于匹配带大括号的大括号内做任意文本的字符串，其中分为了两组，一组是带大括号的内容文本，第二组是大括号内的文本。</li>
<li>定义一个<code>OkHttpClient</code>的实例，名为<code>okHttp</code></li>
<li>定义一个<code>Gson</code>的实例，名为<code>gson</code></li>
<li>定义了一个名为<code>enclosing</code>的<code>lambda</code>表达式，它接收一个<code>Class&lt;*&gt;</code>类型的参数<code>cls</code>，定义一个属性，用于保存当前的<code>Class&lt;*&gt;</code>,之后在函数中定义一个懒序列，在序列中做如下操作：
<ol>
<li>创建一个循环，循环条件是当前<code>class</code>不为空</li>
<li><code>enclosingClass()</code>方法可以获取对应类的直接外部类<code>class</code>对象</li>
<li>序列的<code>next</code>方法就可以拿到<code>yield()</code>方法传递出的内容</li>
<li>通过<code>yield()</code>方法将当前类<code>currentCls</code>放置到队列中</li>
<li>通过<code>currentCls?.enclosingClass</code>获取当前<code>class</code>的直接外部类，并将其赋值给当前类<code>currentCls</code></li>
<li>总结：<code>enclosing</code>表达式的功能就是返回了一个序列，该序列中有某类的一层层的所有外部类</li>
</ol>
</li>
<li><code>create()</code>方法通过动态代理形式去创建一个泛型类型<code>T</code>对象，该函数使用了内联特化。</li>
<li>定义了一个<code>Map</code>类型的属性<code>functionMap</code>，存储泛型<code>T</code>所有函数的名字和函数的键值对</li>
<li>定义了一个<code>List</code>类型的属性<code>interfaces</code>，存储泛型<code>T</code>所有的接口类型的外部类及他自身。通过<code>enclosing()</code>函数将泛型 <code>T</code>的<code>java</code>的<code>class</code>传递进去，返回一个包含泛型<code>T</code>所有外部类的队列，先从泛型<code>T</code>本身类型取逐层往外层的类取，直到外层的类<strong>不是接口</strong>为止，然后将符合的数据转为<code>list</code>，所以该<code>list</code>中外部类元素的顺序是 <strong>从内往外的</strong></li>
<li>定义了一个<code>String</code>类型的属性<code>apiPath</code>，用于存储泛型<code>T</code>所包含的网络路径。通过定义的<code>intetfaces</code>属性取得所有外部类<code>class</code>对象列表，然后通过<code>foldRight()</code>方法从后向前遍历元素 <em>(因为<code>interfaces</code>列表中类顺序是从内向外，而地址是从外往里的)</em>。<code>foldRight()</code>函数有两个参数：一个是初始值，这里定义的初始值是一个<code>StringBuilder</code>对象，一个是以列表中元素和初始值为参数的函数，在该函数中通过 <code>clazz.getAnnotation(Api::class.java)</code>反射得出该类的<code>Api</code>注解对象，之后获取该注解中的<code>url</code>属性的值，若 <code>url</code>是空的，则取该类的类名，之后将取到的取到的地址段通过<code>append</code>方法拼接成一个字符串</li>
<li>通过<code>java</code>反射包中的<code>Proxy.newProxyInstance()</code>创建一个代理类，其中
<ol>
<li>第一个参数传递的是<code>RetroApi</code>类的<code>classloader</code>，</li>
<li>第二个参数传递的是数组类型的接口列表，即传递以泛型<code>T</code>为元素的数组</li>
<li>第三个参数是<code>InvocationHandler</code>类型，也就是一个函数，该函数是一个接口且只有一个方法，所以可以使用<code>lambda</code>表达式，将其从参数列表中往外提</li>
</ol>
</li>
<li><code>InvocationHandler</code>接口中的<code>invoke</code>方法有三个参数： 第一个参数是 <code>Object</code>类型的<code>proxy</code>，第二个参数是 <code>Method</code>类型的<code>method</code>，第三个参数是 <code>Object[]</code>类型的<code>args</code>:
<ol>
<li>在该方法中通过属性<code>functionMap</code>可以得到以<code>method.name</code>为<code>Key</code>值的对应的泛型<code>T</code>中的函数，通过<code>takeIf</code>判断必须该函数必须是抽象的，这样的才需要实现。</li>
<li>之后通过<code>let</code>函数，将之前的取得的抽象的函数作为名为<code>function</code>的参数创建一个匿名函数。</li>
<li>在该匿名函数中，先通过调用函数的<code>valueParameters()</code>方法，获取该函数的形参列表，之后生成形参名称为<code>key</code>，对应形参值为<code>value</code>的键值对组成的<code>map</code>,其名为<code>parameterMap</code></li>
<li>接着通过<code>findAnnotation</code>方法获取该函数某注解实例，在此获取<code>Get</code>注解的实例，取出该注解中<code>url</code>属性的值，若该值为空，则取该函数名，将结果保存到属性<code>endPoint</code>中</li>
<li>之后通过函数<code>Regex</code>匹配正则表达式，再调用<code>findAll</code>获取所有满足正则的内容，之后调用<code>map</code>函数，对每个满足正则文本<code>matchResult</code>进行操作，<code>matchResult.groups</code>有三个元素，第一个元素是匹配的整个字符串；第二个元素是匹配的第一组结果，第三个元素是匹配的第二组结果。此时第一个元素就是属性<code>endPoint</code>存储的字符串，第二个元素就是带大括号的文本，第三个元素就是大括号内的文本，再通过属性<code>parameterMap</code>取得以第三个元素为<code>key</code>值的形参值，将<code>matchResult</code>中的第二个元素的文本的下标范围<code>range</code>作为<code>key</code>，再将形参值作为<code>value</code>，以此构造成键值对组成<code>map</code></li>
<li>通过<code>fold()</code>函数将上一步骤得到的<code>map</code>每个元素进行操作，初始值设置为<code>endPoint</code>,该步骤功能为将<code>endPoint</code>中对应大括号包裹的文本替换为大括号内文本作为形参名对应的形参值</li>
<li>如此得到了将大括号及大括号中广西替换为形参值的字符串，其名为<code>compiledEndPoint</code></li>
<li>定义属性<code>url</code>,用于存储完整的网络地址。也就是将<code>apiPath</code>和<code>compiledEndPoint</code>拼接到一起</li>
<li>调用 <code>okHttp</code>的<code>newCall</code>方法，进行网络请求。先通过<code>Request.Builder()</code>创建一个带<code>url</code>的<code>request</code>，之后调用<code>execute()</code>同步方法发起网络请求，之后获取返回体的<code>charStream</code>，通过<code>use</code>函数对流进行操作，结束时会自动关闭：通过<code>gson</code>的<code>fromJson()</code>方法将返回的内容反序列化，<code>fromJson()</code>方法第一个参数为<code>JsonReader</code>对象，构建对象时将<code>charStream</code>作为参数传入构造方法中；第二个参数为泛型的实参，可通过<code>method.genericReturnType</code>获取</li>
</ol>
</li>
</ol>
<h2><a href="#3-测试反射读取注解请求网络功能" class="header-anchor">#</a><span id="3-测试反射读取注解请求网络功能">3. 测试反射读取注解请求网络功能</span></h2>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> usersApi = RetroApi.create&lt;GitHubApi.Users&gt;()</span><br><span class="line">    println(usersApi.<span class="keyword">get</span>(<span class="string">&quot;puppet16&quot;</span>))</span><br><span class="line">    println(usersApi.followers(<span class="string">&quot;puppet16&quot;</span>).map &#123; it.login &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>打印结果如下：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//api.github.com/users/puppet16</span></span><br><span class="line">User(login=puppet16, location=Beijing, avatar_url=https:<span class="comment">//avatars.githubusercontent.com/u/14159272?v=4, bio=A day is a miniature of eternity. )</span></span><br><span class="line">https:<span class="comment">//api.github.com/users/puppet16/followers</span></span><br><span class="line">[xLily, lianxiaolei, Fakekid]</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>通过单例<code>RetroApi</code>的<code>create</code>方法，创建了一个<code>GitHubApi.Users</code>的实例<code>userApi</code></li>
<li>先获取了用户名为<code>puppet16</code>的<code>GitHub</code>账号信息</li>
<li>又获取了用户名为<code>puppet16</code>的<code>GitHub</code>账号的关注列表</li>
</ol>
<h1><a href="#五-示例-注解加持反射版model映射" class="header-anchor">#</a><span id="五-示例-注解加持反射版model映射">五、示例 – 注解加持反射版<code>Model</code>映射</span></h1>
<p>在<a href="/2021/03/15/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%B8%83/" title="kotlin学习系列七：反射">kotlin学习系列七：反射</a>中的 <strong>示例 – Model映射</strong>章节中，讲到可以通过<code>map</code>映射为任意类型数据类，但是当前实现有缺陷： <code>map</code>中的 <code>key</code>值必须与数据类的属性名字一致</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> To : Any&gt;</span> Map<span class="type">&lt;String, Any?&gt;</span>.<span class="title">mapAs</span><span class="params">()</span></span>: To &#123;</span><br><span class="line">    <span class="keyword">return</span> To::<span class="keyword">class</span>.primaryConstructor!!.let &#123;</span><br><span class="line">        it.parameters.map &#123;</span><br><span class="line">            parameter -&gt;</span><br><span class="line">            parameter to (<span class="keyword">this</span>[parameter.name] ?: <span class="keyword">if</span>(parameter.type.isMarkedNullable) <span class="literal">null</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;<span class="subst">$&#123;parameter.name&#125;</span> is required but missing.&quot;</span>))</span><br><span class="line">        &#125;.toMap()</span><br><span class="line">                .let(it::callBy)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li><code>map</code>中的<code>key</code>值与数据类中的构造方法中的属性名称对应，若<code>map</code>中没有构造方法中参数的值，则判断这个参数是否可以为<code>null</code>，若可以则返回空，否则直接抛异常</li>
<li>判断<code>map</code>中有没有构造方法中参数的值的依据是：将构造方法中的参数名当作了<code>key</code>值去<code>map</code>中取<code>value</code>，如此就必须保证<code>map</code>中存储的<code>key</code>必须与数据类中的构造方法中的属性名称相同</li>
</ol>
<h2><a href="#1-创建支持单个属性别名的注解fildname" class="header-anchor">#</a><span id="1-创建支持单个属性别名的注解fildname">1. 创建支持单个属性别名的注解<code>FildName</code></span></h2>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Target(AnnotationTarget.VALUE_PARAMETER)</span></span><br><span class="line"><span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">FieldName</span>(<span class="keyword">val</span> name: String)</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> To : Any&gt;</span> Map<span class="type">&lt;String, Any?&gt;</span>.<span class="title">mapAs</span><span class="params">()</span></span>: To &#123;</span><br><span class="line">    <span class="keyword">return</span> To::<span class="keyword">class</span>.primaryConstructor!!.let &#123;</span><br><span class="line">        it.parameters.map &#123; parameter -&gt;</span><br><span class="line">            parameter to (<span class="keyword">this</span>[parameter.name]</span><br><span class="line">                ?: (parameter.annotations.filterIsInstance&lt;FieldName&gt;().firstOrNull()?.name?.let(<span class="keyword">this</span>::<span class="keyword">get</span>))</span><br><span class="line">                ?: <span class="keyword">if</span> (parameter.type.isMarkedNullable) <span class="literal">null</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;<span class="subst">$&#123;parameter.name&#125;</span> is required but missing.&quot;</span>))</span><br><span class="line">        &#125;.toMap()</span><br><span class="line">            .let(it::callBy)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Human</span>(<span class="keyword">val</span> name: String,</span><br><span class="line">                 <span class="meta">@FieldName(<span class="string">&quot;avatar_url&quot;</span>)</span></span><br><span class="line">                 <span class="keyword">val</span> avatarUrl: String,</span><br><span class="line">                 <span class="meta">@FieldName(<span class="string">&quot;detail_url&quot;</span>)</span></span><br><span class="line">                 <span class="keyword">val</span> detailUrl: String)</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Person</span>(</span><br><span class="line">        <span class="keyword">var</span> id: <span class="built_in">Int</span>,</span><br><span class="line">        <span class="keyword">var</span> name: String,</span><br><span class="line">        <span class="keyword">var</span> avatar_url: String,</span><br><span class="line">        <span class="keyword">var</span> smallUrl: String,</span><br><span class="line">        <span class="keyword">var</span> detail_url: String</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> personMap = mapOf(</span><br><span class="line">            <span class="string">&quot;id&quot;</span> to <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;name&quot;</span> to <span class="string">&quot;Lee&quot;</span>,</span><br><span class="line">            <span class="string">&quot;avatar_url&quot;</span> to <span class="string">&quot;https://api.github.com/users/Lee&quot;</span>,</span><br><span class="line">            <span class="string">&quot;detail_url&quot;</span> to <span class="string">&quot;https://api.github.com/users/Lee&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> humanFromMap: Human = personMap.mapAs()</span><br><span class="line">    println(humanFromMap)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>打印结果：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Human(name=Lee, avatarUrl=https:<span class="comment">//api.github.com/users/Lee, detailUrl=https://api.github.com/users/Lee)</span></span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>定义了名为<code>FieldName</code>的注解类，包含一个名为<code>name</code>的属性，使用于函数中的参数</li>
<li>改进之前的代码思路：将构造方法中的参数名当作了<code>key</code>值去<code>map</code>中取<code>value</code>时，若返回了<code>null</code>，则去判断这个构造方法的参数是否添加了注解，若有注解<code>FieldName</code>，则取出该注解实例中的<code>name</code>值，否则返回<code>null</code>，之后再走之前逻辑</li>
<li>通过<code>parameter.annotations</code>获取标注在该参数上的所有注解，再通过<code>filterIsInstance&lt;FieldName&gt;()</code>筛选中注解<code>FieldName</code>的实例组成的列表，再通过<code>firstOrNull()</code>方法，取第一个实例，再取其<code>name</code>属性值，再将<code>name</code>中的属性值作为<code>key</code>值，去<code>map</code>中取<code>value</code></li>
<li>该注解只能给单个的属性修改<code>name</code>，若有多个不匹配的属性则要添加多个比较繁琐</li>
</ol>
<h2><a href="#2-创建支持数据类的注解mappingstrategy" class="header-anchor">#</a><span id="2-创建支持数据类的注解mappingstrategy">2. 创建支持数据类的注解<code>MappingStrategy</code></span></h2>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Target(AnnotationTarget.CLASS)</span></span><br><span class="line"><span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">MappingStrategy</span>(<span class="keyword">val</span> klass: KClass&lt;<span class="keyword">out</span> NameStrategy&gt;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">NameStrategy</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">mapTo</span><span class="params">(name: <span class="type">String</span>)</span></span>: String</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> UnderScoreToCamel : NameStrategy &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">mapTo</span><span class="params">(name: <span class="type">String</span>)</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> name.toCharArray().fold(StringBuilder()) &#123; acc, c -&gt;</span><br><span class="line">            <span class="keyword">when</span> (acc.lastOrNull()) &#123;</span><br><span class="line">                <span class="string">&#x27;_&#x27;</span> -&gt; acc[acc.lastIndex] = c.toUpperCase()</span><br><span class="line">                <span class="keyword">else</span> -&gt; acc.append(c)</span><br><span class="line">            &#125;</span><br><span class="line">            acc</span><br><span class="line">        &#125;.toString()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> CamelToUnderScore : NameStrategy &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">mapTo</span><span class="params">(name: <span class="type">String</span>)</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> name.toCharArray().fold(StringBuilder()) &#123; acc, c -&gt;</span><br><span class="line">            <span class="keyword">when</span> &#123;</span><br><span class="line">                c.isUpperCase() -&gt; acc.append(<span class="string">&#x27;_&#x27;</span>).append(c.toLowerCase())</span><br><span class="line">                <span class="keyword">else</span> -&gt; acc.append(c)</span><br><span class="line">            &#125;</span><br><span class="line">            acc</span><br><span class="line">        &#125;.toString()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> To : Any&gt;</span> Map<span class="type">&lt;String, Any?&gt;</span>.<span class="title">mapAs</span><span class="params">()</span></span>: To &#123;</span><br><span class="line">    <span class="keyword">return</span> To::<span class="keyword">class</span>.primaryConstructor!!.let &#123;</span><br><span class="line">        it.parameters.map &#123; parameter -&gt;</span><br><span class="line">            parameter to (<span class="keyword">this</span>[parameter.name]</span><br><span class="line">                    ?: (parameter.annotations.filterIsInstance&lt;FieldName&gt;().firstOrNull()?.name?.let(<span class="keyword">this</span>::<span class="keyword">get</span>))</span><br><span class="line">                    ?: To::<span class="keyword">class</span>.findAnnotation&lt;MappingStrategy&gt;()?.klass?.objectInstance?.mapTo(parameter.name!!)?.let(<span class="keyword">this</span>::<span class="keyword">get</span>)</span><br><span class="line">                    ?: <span class="keyword">if</span> (parameter.type.isMarkedNullable) <span class="literal">null</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;<span class="subst">$&#123;parameter.name&#125;</span> is required but missing.&quot;</span>))</span><br><span class="line">        &#125;.toMap()</span><br><span class="line">                .let(it::callBy)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@MappingStrategy(CamelToUnderScore::class)</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Human</span>(<span class="keyword">val</span> name: String,</span><br><span class="line">                 <span class="keyword">val</span> avatarUrl: String,</span><br><span class="line">                 <span class="keyword">val</span> detailUrl: String)</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Person</span>(</span><br><span class="line">        <span class="keyword">var</span> id: <span class="built_in">Int</span>,</span><br><span class="line">        <span class="keyword">var</span> name: String,</span><br><span class="line">        <span class="keyword">var</span> avatar_url: String,</span><br><span class="line">        <span class="keyword">var</span> smallUrl: String,</span><br><span class="line">        <span class="keyword">var</span> detail_url: String</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> personMap = mapOf(</span><br><span class="line">            <span class="string">&quot;id&quot;</span> to <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;name&quot;</span> to <span class="string">&quot;Lee&quot;</span>,</span><br><span class="line">            <span class="string">&quot;avatar_url&quot;</span> to <span class="string">&quot;https://api.github.com/users/Lee&quot;</span>,</span><br><span class="line">            <span class="string">&quot;detail_url&quot;</span> to <span class="string">&quot;https://api.github.com/users/Lee&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> humanFromMap: Human = personMap.mapAs()</span><br><span class="line">    println(humanFromMap)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>打印结果：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Human(name=Lee, avatarUrl=https:<span class="comment">//api.github.com/users/Lee, detailUrl=https://api.github.com/users/Lee)</span></span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>定义名为<code>MappingStrategy</code>的注解，接口类型为<code>KClass</code>的策略类，这个策略类必须实现接口<code>NameStrategy</code>，该接口中有一个函数<code>mapTo()</code>，功能是将入参<code>name</code>转为另一个<code>name</code>，使用于类上</li>
<li>该注解用于解决多个参数名称不匹配的问题，避免多次使用注解<code>FieldName</code></li>
<li>创建一个实现接口<code>NameStrategy</code>的单例类<code>UnderScoreToCamel</code>，用于 <strong>将下划线风格的属性名称转为驼峰风格</strong>的属性名称。将传入的<code>name</code>转为字符数组，再通过<code>fold()</code>函数遍历每个字符，<code>acc</code>是<code>StringBuilder</code>类型，每次循环都将当前字符<code>c</code>添加到该属性中，判断如果<code>acc</code>最后一位是下划线，就将下划线的位置替换为大写的当前字符，否则就继续给<code>acc</code>添加当前字符。之后返回<code>StringBuilder</code>类型的<code>acc</code>，最后再调用<code>toString()</code>方法转为字符串。</li>
<li>创建一个实现接口<code>NameStrategy</code>的单例类<code>CamelToUnderScore</code>，用于 <strong>将驼峰风格的属性名称转为下划线风格</strong>的属性名称。实现逻辑与<code>UnderScoreToCamel</code>类似，只是判断条件变为了：如果当前字符<code>c</code>是大写的，就在其之前加个下划线，再添加小写的该字符；否则就直接给<code>acc</code>添加当前字符。之后返回<code>StringBuilder</code>类型的<code>acc</code>，最后再调用<code>toString()</code>方法转为字符串。</li>
<li>因为策略不需要每次做映射的时候都去创建，所以两个实现接口<code>NameStrategy</code>的策略类都定义为单例类型</li>
<li>之后再对<code>mapAs()</code>方法进行改造，在判断了<code>FieldName</code>注解之后，再判断注解<code>MappingStrategy</code>：
<ol>
<li>先获取要转换成的类的<code>To</code>上修饰的注解<code>MappingStrategy</code></li>
<li>再获取该注解类中的策略类的<code>KClass</code></li>
<li>因为策略类是单例，调用<code>objectInstance</code>，创建出该单例的实例，若存在则不会再次创建</li>
<li>再调用该单例中的<code>mapTo</code>方法，将目标类<code>To</code>中的参数名称按策略中的规则转换为其它风格的名称</li>
<li>最后再使用该名称去<code>map</code>中取出对应的<code>value</code>值</li>
</ol>
</li>
<li>给<code>Human</code>数据类添加注解<code>MappingStrategy</code>，可以看到该数据类中属性名字是驼峰类型的，而<code>Person</code>中对应的属性名字是下划线类型的，要将<code>person</code>转为<code>human</code>，则策略类使用<code>CamelToUnderScore</code>，否则无法在<code>map</code>中找到应对的属性名</li>
</ol>
<h1><a href="#六-示例-注解处理器版-model-映射" class="header-anchor">#</a><span id="六-示例-注解处理器版-model-映射">六、 示例 – 注解处理器版 <code>Model</code> 映射</span></h1>
<blockquote>
<p>上一章节中讲述通过注解处理不同命名风格的属性的映射，但是每次都要调用自己写的<code>mapAs()</code>。<br>
本章主要讲如何通过注解处理器自动生成<code>modul</code>自己的<code>mapAs()</code>方法</p>
</blockquote>
<h2><a href="#1-简述java编译过程" class="header-anchor">#</a><span id="1-简述java编译过程">1. 简述<code>java</code>编译过程</span></h2>
<p><strong>编译流程：</strong></p>
<ol>
<li>词法分析：词法分析的输入是 <strong>源程序</strong> <em>(即<code>java</code>文件)</em>，输出是识别出的 <strong>记号流</strong>。目的是识别单词。单词至少分以下几类：关键字 <em>(保留字)</em>、标识符、字面量、特殊符号</li>
<li>语法分析：输入是词法分析器返回的 <strong>记号流</strong>，输出是 <strong>语法树</strong>。目的是得到语言结构并以树的形式表示。对于声明性语句，进行符号表的查填，对于可执行语句，检查结构合理的表达式运算是否有意义。</li>
<li>语义分析：根据语义规则对语法树中的语法单元 <strong>进行静态语义检查</strong>，如类型检查和转换等，目的在于保证语法正确的结构在语义分析上也是合法的。</li>
<li>中间代码生成(可选)：生成一种既接近目标语言，又与具体机器无关的表示，便于代码优化与代码生成。<br>
<em>(到目前为止，编译器与解释器可以一致)</em></li>
<li>中间代码优化(可选)：局部优化、循环优化、全局优化等；优化实际上是一个等价变换，变换前后的指令序列完成同样的功能，但在占用的空间上和程序执行的时间上都更省、更有效</li>
<li>目标代码生成：不同形式的目标代码—汇编语言形式、可重定位二进制代码形式、内存形式(Load-and-Go)</li>
<li>符号表管理：合理组织符号，便于各阶段查找\填写等。</li>
<li>出错处理</li>
</ol>
<p><img src="/2021/03/23/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%85%AB/java_complier_process.png" alt="attar"></p>
<p><strong>说明：</strong></p>
<ol>
<li>抽象语法树 <em>(Abstract Syntax Tree, AST)</em> 是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的结构。</li>
<li>将源文件进行解析，构造抽象语法树，符号表填充，最输出扩展名为<code>.class</code>的字节码文件</li>
<li>在编译过程中会调用注解处理器<code>APT</code><em>(Annotation Process Tool)</em> 扫描和处理注解，按照一定的规则，生成相应的<code>java</code>文件，然后再进行编译，注解处理器一般生成新的源文件，而不是更改之前源文件的语法树</li>
<li>参考文章：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/af78a314c6fc">.java文件编译过程和执行过程分析</a></li>
</ol>
<p><strong>代码生成三方工具</strong>：</p>
<ul>
<li>生成<code>Java</code>代码： <strong>JavaPoet</strong></li>
<li>生成<code>Kotlin</code>代码： <strong>KotlinPoet</strong></li>
</ul>
<h2><a href="#2-开源库kotlinpoet" class="header-anchor">#</a><span id="2-开源库kotlinpoet">2. 开源库<code>KotlinPoet</code></span></h2>
<p><strong>官网：</strong> <a target="_blank" rel="noopener" href="https://square.github.io/kotlinpoet/">KotlinPoet</a></p>
<p><code>KotlinPoet</code>是一个用于生成扩展名为<code>.kt</code>的<code>kotlin</code>文件的开源库，他支持<code>Kotlin</code>和<code>Java</code>语句</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> personClass = ClassName(<span class="string">&quot;cn.lee.kotlin&quot;</span>, <span class="string">&quot;Person&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> file = FileSpec.builder(<span class="string">&quot;cn.lee.kotlin&quot;</span>, <span class="string">&quot;KotlinPoetTest&quot;</span>)</span><br><span class="line">         .addType(TypeSpec.classBuilder(<span class="string">&quot;Person&quot;</span>)</span><br><span class="line">               .primaryConstructor(FunSpec.constructorBuilder()</span><br><span class="line">                        .addParameter(<span class="string">&quot;name&quot;</span>, String::<span class="keyword">class</span>)</span><br><span class="line">                        .build())</span><br><span class="line">               .addProperty(PropertySpec.builder(<span class="string">&quot;name&quot;</span>, String::<span class="keyword">class</span>)</span><br><span class="line">                        .initializer(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">                        .build())</span><br><span class="line">               .addProperty(PropertySpec.builder(<span class="string">&quot;age&quot;</span>, <span class="built_in">Int</span>::<span class="keyword">class</span>)</span><br><span class="line">                        .initializer(<span class="string">&quot;18&quot;</span>)</span><br><span class="line">                        .build())</span><br><span class="line">               .addFunction(FunSpec.builder(<span class="string">&quot;printContent&quot;</span>)</span><br><span class="line">                        .addStatement(<span class="string">&quot;println(%P)&quot;</span>, <span class="string">&quot;name= \$name&quot;</span>)</span><br><span class="line">                        .build())</span><br><span class="line">               .build())</span><br><span class="line">         .addFunction(FunSpec.builder(<span class="string">&quot;main&quot;</span>)</span><br><span class="line">               .addParameter(<span class="string">&quot;args&quot;</span>, String::<span class="keyword">class</span>, KModifier.VARARG)</span><br><span class="line">               .addStatement(<span class="string">&quot;%T(args[0]).printContent()&quot;</span>, personClass)</span><br><span class="line">               .build())</span><br><span class="line">         .build()</span><br><span class="line">file.writeTo(System.<span class="keyword">out</span>)</span><br></pre></td></tr></table></figure>
<p><strong>打印结果：</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.lee.kotlin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kotlin.<span class="built_in">Int</span></span><br><span class="line"><span class="keyword">import</span> kotlin.String</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(</span><br><span class="line">  <span class="keyword">val</span> name: String</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">val</span> age: <span class="built_in">Int</span> = <span class="number">18</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">printContent</span><span class="params">()</span></span> &#123;</span><br><span class="line">    println(<span class="string">&quot;&quot;&quot;name= <span class="variable">$name</span>&quot;&quot;&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(<span class="keyword">vararg</span> args: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">  Person(args[<span class="number">0</span>]).printContent()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li><code>ClassName</code>作用是提供一个全称类名。该类必须是顶级成员</li>
<li><code>FileSpec</code>用于创建<code>Kotlin</code>文件内容。内容包含顶级对象 <em>（如类、对象、函数、属性和类型别名）</em>, 通过<code>Builder</code>创建</li>
<li><code>FileSpec.builder</code>方法中两个入参分别是创建的内容的文件所在包名及创建的内容的文件名
<ol>
<li><code>addType()</code>方法是创建一个类。它接收一个<code>TypeSpec</code>对象作为参数</li>
<li><code>addFunction()</code>方法是创建一个函数。它接收一个<code>FunSpec</code>对象作为参数</li>
</ol>
</li>
<li><code>TypeSpec</code>用于生成类、接口或枚举声明</li>
<li><code>TypeSpec.classBuilder()</code>方法中的入参是创建的类的类名
<ol>
<li><code>primaryConstructor()</code>方法是给要创建的类添加主构造器，其入参为<code>FunSpec.constructorBuilder</code>创建的构造器对象</li>
<li><code>addProperty()</code>方法为类添加属性。其入参为<code>PropertySpec</code>对象</li>
<li><code>addFunction()</code>方法为类添加函数。其入参为<code>FunSpec</code>对象</li>
</ol>
</li>
<li><code>PropertySpec</code>用于生成属性</li>
<li><code>PropertySpec.builder()</code>方法中第一个入参是属性名称，第二个入参是属性类型
<ol>
<li><code>initializer()</code>方法是为创建的属性赋初值，入参必须是<code>String</code>类型</li>
<li>若该方法创建的属性与<code>FunSpec.constructorBuilder</code>语句创建构造器时添加的属性名称一致时，会将属性合并到构造器中声明</li>
</ol>
</li>
<li><code>FunSpec</code>用于生成函数的声明</li>
<li><code>FunSpec.constructorBuilder()</code>用于创建一个构造器函数</li>
<li><code>FunSpec.builder</code>方法用于创建一个函数。它接收一个<code>String</code>对象作为参数，该参数即为创建的函数的名字
<ol>
<li><code>addParameter()</code>方法为函数添加入参。第一个参数一般是入参名称，第二个参数是入参类型，第三个参数是入参修饰符</li>
<li><code>addStatement()</code>方法为函数的函数体添加一条语句。第一个参数是具体语句，第二个参数是第一个参数中具体语句要使用的可变的内容，如字符串、类等。 用到第二个参数时 <strong>第一个参数需要添加占位符</strong>，第二个参数类型由占位符确定，<strong>占位符一定要大写</strong>
<table>
<thead>
<tr>
<th>占位符</th>
<th>含义</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>%S</td>
<td>替换字符串</td>
<td>.addStatement(“return %S”, name)</td>
<td>只能替换一般文本，如果有$会将其进行转义</td>
</tr>
<tr>
<td>%P</td>
<td>替换含有$的字符串，即字符串模板</td>
<td>.addStatement(“println(%P)”, “name= $name”)</td>
<td>会将$符号作为正常文本</td>
</tr>
<tr>
<td>%T</td>
<td>替换某个类</td>
<td>.addStatement(“return %T()”, Date::class) <br> .addStatement(“%T(args[0]).printContent()”, ClassName(“cn.lee.kotlin”, “Person”))</td>
<td>若替换的是在 生成代码时恰好可用的类，则第二个参数是某个类的<code>class</code>引用，此时会自动将该类的包导入；<br> 若要引用了一个不存在的类 <em>(生成代码时尚未存在)</em>，则第二个参数是<code>ClassName</code>对象</td>
</tr>
</tbody>
</table>
</li>
</ol>
</li>
<li>上述代码生成的文件<code>KotlinPoetTest.kt</code>地址：module名称/build/generated/source/kapt/debug/cn/lee/kotlin<br>
<img src="/2021/03/23/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%85%AB/apt_file_generate.png" alt="attar"></li>
</ol>
<h2><a href="#3-注解处理器abstractprocessor" class="header-anchor">#</a><span id="3-注解处理器abstractprocessor">3. 注解处理器<code>AbstractProcessor</code></span></h2>
<h3><a href="#1-自定义注解处理器" class="header-anchor">#</a><span id="1-自定义注解处理器">1. 自定义注解处理器</span></h3>
<p><code>AbstractProcessor</code>类是<code>Java API</code>提供的扫描源码并解析注解的框架，可以继承该抽象类来实现自己的解析注解逻辑。</p>
<p>自定义注解处理器所在的类是帮助我们生成需要的代码源文件的，我们最后需要的是他生成的文件，最后打包进apk也是他生成的文件，自定义注解处理器所在的类本身是不需要打包的，所以自定义注解处理类不需要放到打包的工程<code>Module</code>中。</p>
<p>继承<code>AbstractProcessor</code>的类需要实现以下四个方法：</p>
<ul>
<li><code>init()</code>方法<br>
会被注解处理工具调用，在这里可以做一些 <strong>初始化</strong> 的工作</li>
<li><code>process()</code>方法<br>
<strong>相当于每个处理器的主函数<code>main()</code></strong>，在这里写扫描、评估和处理注解的代码，以及生成代码。<br>
该方法提供两个参数：
<ol>
<li><code>java.lang.model.element.TypeElement</code>对象的<code>Set</code>集合：处理注解的过程要经过一个或者多个回合才能完成。每个回合中注解处理器都会被调用，并且接收到一个以在当前回合中已经处理过的注解类型的<code>Type</code>为元素的<code>Set</code>集合。</li>
<li><code>javax.annotation.processing.RoundEnvironment</code>对象：通过这个对象可以访问到当前或者之前的回合中处理的<code>Element</code>元素 <code>(即可以被注解类型注解的元素，如类、方法、参数等等)</code>，只有被注解处理器注册的注解类型注解过的元素才会被处理。</li>
</ol>
</li>
<li><code>getSupportedSourceVersion()</code>方法<br>
指定使用的<code>Java</code>版本，通常这里返回<code>SourceVersion.latestSupported()</code>，默认返回<code>SourceVersion.RELEASE_6</code>，<strong>该方法可以使用注解 <code>@SupportedSourceVersion</code>替代</strong></li>
<li><code>getSupportedAnnotationTypes()</code>方法<br>
指定这个注解处理器是注册给哪个注解的。<strong>注意:</strong> 它的返回值是一个字符串的集合，包含本处理器想要处理的注解类型的合法全称，即注解器所支持的注解类型集合，如果没有这样的类型，则返回一个空集合，<strong>该方法可以使用注解 <code>@SupportedAnnotationTypes</code>替代</strong></li>
</ul>
<h3><a href="#2-声明自定义注解处理器" class="header-anchor">#</a><span id="2-声明自定义注解处理器">2. 声明自定义注解处理器</span></h3>
<ol>
<li>需要在处理器所在<code>module</code>的<code>main</code>目录中创建<code>resources</code>文件夹</li>
<li>再在<code>resources</code>文件夹下创建<code>META-INF.services</code>的文件夹</li>
<li>最后在<code>META-INF.services</code>的文件夹中创建文件<code>javax.annotation.processing.Processor</code></li>
<li>之后在该文件中写入自定义注解处理器的类全称</li>
</ol>
<h2><a href="#4-注解解析器element" class="header-anchor">#</a><span id="4-注解解析器element">4. 注解解析器<code>Element</code></span></h2>
<p><code>element</code>指的是一系列与之相关的接口集合，它们位于<code>javax.lang.model.element</code>包下面。<br>
<code>element</code>是代表程序的一个元素，这个元素可以是：<strong>包、类/接口、属性变量、方法/方法形参、泛型参数</strong>。<br>
<code>element</code>是<code>java-apt</code> <em>(编译时注解处理器)</em> 技术的基础<br>
可以将<code>element</code>看作是<code>java</code>编译过程中语法分析后得出的语法树，每个类都是一个树，一个类是最外层的根节点，类变量和实例变量是根节点下的一个子节点，方法是另一个根节点，而方法中的变量又可以看成这个方法的子节点，依次类推下去。通过面向对象的方法我们将这个节点抽象出一个<code>element</code>类，这个类就提取出变量节点或者方法节点的一些相同的属性，<strong><code>Element</code>就作为一个顶级的父类</strong>。</p>
<p>各种<code>element</code>所代表的元素类型如下图所示：<br>
<img src="/2021/03/23/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%85%AB/element_type_description.png" alt="attar"></p>
<p><strong>说明：</strong></p>
<ol>
<li><code>PackageElement</code> 代表包的接口</li>
<li><code>TypeElement</code> 代表<code>java</code>程序中的类或者接口。提供访问该类型和其内部成员的一些方法。注意：枚举类型看做是类,注解类型看做是接口</li>
<li><code>VariableElement</code> 代表一个字段,枚举常量,方法或者构造器的参数,本地变量,<code>try-with-resource</code>中的<code>resource</code> 变量,或者是异常参数<br>
<code>try-with-resources</code>语句是一种声明了一种或多种资源的<code>try</code>语句。资源是指在程序用完了之后必须要关闭的对象<code>try-with-resources</code>语句保证了每个声明了的资源在语句结束的时候都会被关闭。任何实现了<code>java.lang.AutoCloseable</code>接口的对象，和实现了<code>java.io.Closeable</code>接口的对象，都可以当做资源使用</li>
<li><code>TypeParameterElement</code> 代表泛型类,接口,方法或者构造器的形式类型参数。一个类型参数就对应的一个类型变量</li>
<li><code>ExecutableElement</code> 代表一个类或者接口的方法,构造器,或者初始块(静态或者实例的),包括注解类型。是<code>Parameterizable</code>的子接口</li>
</ol>
<h2><a href="#5-实现注解处理器版-model-映射" class="header-anchor">#</a><span id="5-实现注解处理器版-model-映射">5. 实现注解处理器版 <code>Model</code> 映射</span></h2>
<h3><a href="#1-创建注解" class="header-anchor">#</a><span id="1-创建注解">1. 创建注解</span></h3>
<p>在自己创建的目录<code>apt</code>下创建 名为<code>annotations</code>的<code>module</code></p>
<p><img src="/2021/03/23/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%85%AB/apt_annotations.png" alt="attar"></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//build.gradle</span></span><br><span class="line"></span><br><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;org.jetbrains.kotlin.jvm&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group <span class="string">&#x27;cn.lee.kotlin&#x27;</span></span><br><span class="line">version <span class="string">&#x27;1.0-SNAPSHOT&#x27;</span></span><br><span class="line"></span><br><span class="line">sourceCompatibility = <span class="number">1.8</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">&quot;org.jetbrains.kotlin:kotlin-stdlib-jdk8&quot;</span></span><br><span class="line">    testImplementation group: <span class="string">&#x27;junit&#x27;</span>, name: <span class="string">&#x27;junit&#x27;</span>, version: <span class="string">&#x27;4.12&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">compileKotlin &#123;</span><br><span class="line">    kotlinOptions.jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">compileTestKotlin &#123;</span><br><span class="line">    kotlinOptions.jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ModeMap.kt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.lee.kotlin.annotations.apt</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention(AnnotationRetention.BINARY)</span></span><br><span class="line"><span class="meta">@Target(AnnotationTarget.CLASS)</span></span><br><span class="line"><span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">ModelMap</span></span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>在该<code>module</code>中创建了一个注解类<code>ModelMap</code></li>
<li>该注解类作用于类上，且注解信息记录在编译之后的二进制文件中，但对反射不可见</li>
</ol>
<h3><a href="#2-创建注解处理器" class="header-anchor">#</a><span id="2-创建注解处理器">2. 创建注解处理器</span></h3>
<h4><a href="#1-添加依赖包" class="header-anchor">#</a><span id="1-添加依赖包">1. 添加依赖包</span></h4>
<p>在自己创建的目录<code>apt</code>下创建 名为<code>compiler</code>的<code>module</code></p>
<p><img src="/2021/03/23/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%85%AB/apt_compiler.png" alt="attar"></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//build.gradle</span></span><br><span class="line"></span><br><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;org.jetbrains.kotlin.jvm&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group <span class="string">&#x27;cn.lee.kotlin&#x27;</span></span><br><span class="line">version <span class="string">&#x27;1.0-SNAPSHOT&#x27;</span></span><br><span class="line"></span><br><span class="line">sourceCompatibility = <span class="number">1.8</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">&quot;org.jetbrains.kotlin:kotlin-stdlib-jdk8&quot;</span></span><br><span class="line"></span><br><span class="line">    implementation <span class="string">&quot;com.squareup:kotlinpoet:1.4.3&quot;</span></span><br><span class="line">    implementation <span class="string">&quot;com.bennyhuo.aptutils:aptutils:1.7.1&quot;</span></span><br><span class="line">    implementation project(<span class="string">&quot;:apt:annotations&quot;</span>)</span><br><span class="line"></span><br><span class="line">    testImplementation group: <span class="string">&#x27;junit&#x27;</span>, name: <span class="string">&#x27;junit&#x27;</span>, version: <span class="string">&#x27;4.12&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">compileKotlin &#123;</span><br><span class="line">    kotlinOptions.jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">compileTestKotlin &#123;</span><br><span class="line">    kotlinOptions.jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>注解处理器所在的<code>module</code>需要添加注解<code>module</code>的依赖以方便读取注解</li>
<li>注解处理器要根据注解生成对应<code>Kotlin</code>代码，所以添加<code>KotlinPoet</code>的依赖</li>
<li>为了方便的编写注解处理器，添加了<code>bennyhuo</code>老师的开源库<code>aptutils</code></li>
</ol>
<h4><a href="#2-创建处理器" class="header-anchor">#</a><span id="2-创建处理器">2. 创建处理器</span></h4>
<p>创建文件名为<code>ModelMapProcessor</code>的注解处理器</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ModelMapProcessor.kt</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SupportedAnnotationTypes(<span class="string">&quot;cn.lee.kotlin.annotations.apt.ModelMap&quot;</span>)</span></span><br><span class="line"><span class="meta">@SupportedSourceVersion(SourceVersion.RELEASE_8)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelMapProcessor</span>: <span class="type">AbstractProcessor</span>() &#123;</span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">init</span><span class="params">(processingEnv: <span class="type">ProcessingEnvironment</span>)</span></span> &#123;</span><br><span class="line">      <span class="keyword">super</span>.<span class="keyword">init</span>(processingEnv)</span><br><span class="line">      AptContext.<span class="keyword">init</span>(processingEnv)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">process</span><span class="params">(annotations: <span class="type">MutableSet</span>&lt;<span class="type">out</span> <span class="type">TypeElement</span>&gt;, roundEnv: <span class="type">RoundEnvironment</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">      roundEnv.getElementsAnnotatedWith(ModelMap::<span class="keyword">class</span>.java)</span><br><span class="line">         .forEach &#123;</span><br><span class="line">               element -&gt;</span><br><span class="line">               element.enclosedElements.filterIsInstance&lt;ExecutableElement&gt;()</span><br><span class="line">                  .firstOrNull &#123; it.simpleName() == <span class="string">&quot;&lt;init&gt;&quot;</span> &#125;</span><br><span class="line">                  ?.let &#123;</span><br><span class="line">                     <span class="keyword">val</span> typeElement = element <span class="keyword">as</span> TypeElement</span><br><span class="line">                     FileSpec.builder(typeElement.packageName(), <span class="string">&quot;<span class="subst">$&#123;typeElement.simpleName()&#125;</span>\$\$ModelMap&quot;</span>)</span><br><span class="line">                           .addFunction(</span><br><span class="line">                              FunSpec.builder(<span class="string">&quot;toMap&quot;</span>)</span><br><span class="line">                                 .receiver(typeElement.asType().asKotlinTypeName())</span><br><span class="line">                                 .addStatement(<span class="string">&quot;return mapOf(<span class="subst">$&#123;it.parameters.joinToString &#123;<span class="string">&quot;&quot;&quot;&quot;<span class="subst">$&#123;it.simpleName()&#125;</span>&quot; to <span class="subst">$&#123;it.simpleName()&#125;</span>&quot;&quot;&quot;</span> &#125;</span>&#125;)&quot;</span>)</span><br><span class="line">                                 .build()</span><br><span class="line">                           )</span><br><span class="line">                           .addFunction(</span><br><span class="line">                              FunSpec.builder(<span class="string">&quot;to<span class="subst">$&#123;typeElement.simpleName()&#125;</span>&quot;</span>)</span><br><span class="line">                                 .addTypeVariable(TypeVariableName(<span class="string">&quot;V&quot;</span>))</span><br><span class="line">                                 .receiver(MAP.parameterizedBy(STRING, TypeVariableName(<span class="string">&quot;V&quot;</span>)))</span><br><span class="line">                                 .addStatement(</span><br><span class="line">                                       <span class="string">&quot;return <span class="subst">$&#123;typeElement.simpleName()&#125;</span>(<span class="subst">$&#123;it.parameters.joinToString&#123; <span class="string">&quot;&quot;&quot;this[&quot;<span class="subst">$&#123;it.simpleName()&#125;</span>&quot;] as %T &quot;&quot;&quot;</span> &#125;</span> &#125;)&quot;</span>,</span><br><span class="line">                                       *it.parameters.map &#123; it.asType().asKotlinTypeName() &#125;.toTypedArray()</span><br><span class="line">                                 )</span><br><span class="line">                                 .build()</span><br><span class="line">                           )</span><br><span class="line">                           .build().writeToFile()</span><br><span class="line">                  &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>该示例中指定该处理器只支持注解<code>ModelMap</code></li>
<li>该示例中初始化了开源库<code>aptutils</code>中的<code>AptContext</code></li>
<li>该示例中使用注解指定了<code>java</code>版本为<em>1.8</em></li>
<li>通过上下文<code>roundEnv</code>的<code>getElementsAnnotatedWith()</code>方法获取被某注解标注的元素，该方法入参为注解的<code>java</code>的<code>class</code>，返回的是一个元素集合</li>
<li>再通过<code>forEach</code>语句对元素列表中每个元素进行处理</li>
<li><code>element.enclosedElements</code> 语句返回该元素所包含的元素列表。类或接口被认为包含了它直接声明的字段、方法、构造函数和成员类型。包直接包含了顶级类和接 口，但不包含其子包</li>
<li><code>.filterIsInstance&lt;ExecutableElement&gt;()</code>语句返回某类元素实例列表。此时是从上条语句中得到的元素列表中过滤出<code>ExecutableElement</code>类型的元素实例</li>
<li><code>firstOrNull</code>语句返回符合筛选条件的对象，此时它的筛选条件是<code>it.simpleName() == &quot;&lt;init&gt;&quot;</code>,即筛选出构造器对象</li>
<li>将<code>element</code>强转为<code>TypeElement</code>类型的属性<code>typeElement</code></li>
<li>使用<code>KotlinPoet</code>中的<code>FileSpec.builder</code>语句来创建<code>kotlin</code>文件内容
<ol>
<li><code>typeElement.packageName()</code>为开源库<code>aptutils</code>中对<code>TypeElement</code>类的扩展方法，用于获取该<code>element</code>所在的顶级元素的包名。如此创建的<code>kotlin</code>文件所在的包名即为该元素所在顶级元素的包名</li>
<li><code>$&#123;typeElement.simpleName()&#125;\$\$ModelMap</code>，是取被标注的类的简单名字加上两个$符号再加上字符串<code>ModelMap</code>,最后拼接成的字符串即为创建的<code>kotlin</code>文件的名字</li>
<li>通过<code>addFunction()</code>方法为创建的<code>kotlin</code>文件添加了名为<code>toMap</code>的函数，该函数功能是将主构造器中的参数生成一个<code>Map</code>,并将其返回。
<ol>
<li>通过<code>receiver()</code>为<code>toMap</code>函数添加<code>receiver</code>，即<code>toMap</code>函数为该<code>receiver</code>的扩展函数。此时我们使用入参为<code>TypeName</code>类型参数的<code>receiver()</code>方法，使用<code>aptutils</code>的<code>typeElement.asType().asKotlinTypeName()</code>方法，可以解决<code>Kotlin</code>中一些类型映射问题，避免在<code>Kotlin</code>文件中出现<code>Java</code>的类型，而直接使用<code>typeElement.asClassName()</code>获取的<code>TypeName</code>类型，就可能会出现在生成的<code>Kotlin</code>代码中使用<code>Java</code>的类</li>
<li>通过<code>addStatement()</code>方法为函数添加一行代码，实现的代码示例为：<em><code>return mapOf(&quot;name&quot; to name, &quot;age&quot; to age)</code></em><br>
<code>joinToString()</code>方法功能为遍历集合元素，为集合元素间添加分隔符，组成一个新的字符串并返回。默认分隔符为逗号。<br>
<code>$&#123;it.parameters.joinToString &#123;&quot;&quot;&quot;&quot;$&#123;it.simpleName()&#125;&quot; to $&#123;it.simpleName()&#125;&quot;&quot;&quot; &#125;&#125;</code>语句作用是遍历主构造器中的参数列表，将参数列表组成键值对，所以<code>to</code>前的参数名称添加了双引号，后面的没有。</li>
</ol>
</li>
<li>通过<code>addFunction()</code>方法为创建的<code>kotlin</code>文件添加函数，函数名为<code>to</code>加上被注解<code>@ModelMap</code>所修饰的类的简单类名。该函数功能是根据<code>Map</code>生成被<code>@ModelMap</code>标注的类对象。
<ol>
<li>通过<code>addTypeVariable()</code>为该函数声明一个泛型，通过语句<code>TypeVariableName()</code>定义该泛型名称,此时声明该泛型为<code>V</code></li>
<li>通过<code>receiver()</code>为该函数添加<code>receiver</code>，<code>MAP.parameterizedBy()</code>方法返回一个设置了<code>Key</code>和<code>value</code>类型的<code>Map</code>，此时<code>key</code>为<code>String</code>，<code>value</code>就是之前声明的泛型<code>V</code></li>
<li>通过<code>addStatement()</code>方法为该函数添加一条语句，生成代码示例为：<em><code>Human(this[&quot;name&quot;] as String , this[&quot;age&quot;] as Int)</code></em><br>
通过<code>it.parameters.joinToString()</code>方法遍历主构造器中参数列表，取出以参数名为<code>Key</code>的存于<code>Map</code>中的<code>value</code>值，因为<code>value</code>值对应的<code>map</code>中的类型是泛型可以是任何类型，所以在此处还要进行类型转换，使用<code>%T</code>。注意：<strong>有几个形参就会有几个<code>%T</code></strong><br>
<code>*it.parameters.map &#123; it.asType().asKotlinTypeName() &#125;.toTypedArray()</code>是<code>addStatement()</code>方法的第二个参数，用于替换<code>%T</code>，第二个参数是变长参数，而我们最后返回的是一个数组，所以需要加星号，将数组展开便于传值。</li>
</ol>
</li>
<li>最后通过<code>aptutils</code>中的<code>writeToFile()</code>方法将文件内容与入到文件中</li>
</ol>
</li>
</ol>
<h4><a href="#3-添加处理器声明" class="header-anchor">#</a><span id="3-添加处理器声明">3. 添加处理器声明</span></h4>
<p>创建好注解处理器后，我们需要告诉编译器在编译的时候使用哪个注解处理器<br>
<img src="/2021/03/23/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%85%AB/apt_compiler.png" alt="attar"></p>
<p><strong>说明：</strong></p>
<ol>
<li>在<code>javax.annotation.processing.Processor</code>文件中写入自定义注解处理器的类全称：<code>cn.lee.kotlin.annotations.apt.compiler.ModelMapProcessor</code></li>
</ol>
<h3><a href="#3-测试注解处理器" class="header-anchor">#</a><span id="3-测试注解处理器">3. 测试注解处理器</span></h3>
<p>在主<code>Module</code>下进行测试</p>
<h4><a href="#1-buildgradlekts配置" class="header-anchor">#</a><span id="1-buildgradlekts配置">1. <code>build.gradle.kts</code>配置</span></h4>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//build.gradle.kts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jetbrains.kotlin.config.KotlinCompilerVersion</span><br><span class="line">plugins &#123;</span><br><span class="line">    id (<span class="string">&quot;com.android.application&quot;</span>)</span><br><span class="line">    id (<span class="string">&quot;kotlin-android&quot;</span>)</span><br><span class="line">    kotlin(<span class="string">&quot;kapt&quot;</span>)</span><br><span class="line">    kotlin(<span class="string">&quot;jvm&quot;</span>) version <span class="string">&quot;1.4.30&quot;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        sourceCompatibility = JavaVersion.VERSION_1_8</span><br><span class="line">        targetCompatibility = JavaVersion.VERSION_1_8</span><br><span class="line">        kotlinOptions.jvmTarget  = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    ...</span><br><span class="line">    implementation(kotlin(<span class="string">&quot;stdlib-jdk8&quot;</span>, KotlinCompilerVersion.VERSION))</span><br><span class="line">    <span class="comment">//注解处理器示例</span></span><br><span class="line">    kapt (project(<span class="string">&quot;:apt:compiler&quot;</span>))</span><br><span class="line">    implementation (project(<span class="string">&quot;:apt:annotations&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>添加<code>kapt</code>的插件支持</li>
<li>设置<code>kotlin</code>在编译时使用的<code>jvmTarget</code>是<code>1.8</code>版本</li>
<li>添加注解模块的运行时依赖</li>
<li>自定义注解处理器所在的<code>module</code>并不是运行时的依赖，我们只需要处理器生成的文件</li>
<li><a target="_blank" rel="noopener" href="http://www.kotlincn.net/docs/reference/kapt.html">Kapt官网</a></li>
</ol>
<h4><a href="#2-创建测试文件" class="header-anchor">#</a><span id="2-创建测试文件">2. 创建测试文件</span></h4>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.lee.kotlin.annotations.apt.ModelMap</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> person = Person(<span class="string">&quot;Lee&quot;</span>, <span class="number">18</span>)</span><br><span class="line">    <span class="keyword">val</span> human = person.toMap().toHuman()</span><br><span class="line">    println(person)</span><br><span class="line">    println(human)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//fun Human.toMap() = mapOf(&quot;name&quot; to name, &quot;age&quot; to age)</span></span><br><span class="line"><span class="comment">//fun &lt;V&gt; Map&lt;String, V&gt;.toHuman() = Human(this[&quot;name&quot;] as String , this[&quot;age&quot;] as Int)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ModelMap</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Human</span>(<span class="keyword">val</span> name: String, <span class="keyword">val</span> age :<span class="built_in">Int</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@ModelMap</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Person</span>(<span class="keyword">val</span> name: String, <span class="keyword">val</span> age :<span class="built_in">Int</span>, <span class="keyword">val</span> address:String = <span class="string">&quot;china&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>打印结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Person(name=Lee, age=<span class="number">18</span>, address=china)</span><br><span class="line">Human(name=Lee, age=<span class="number">18</span>)</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>
<p>创建两个数据类<code>Human</code>、<code>Person</code>，为这两个类添加注解<code>@ModelMap</code>，如此对应生成的文件名为<code>Human$$ModelMap.kt</code>、<code>Person$$ModelMap.kt</code>,地址如下：<br>
<img src="/2021/03/23/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%85%AB/apt_file_generate2.png" alt="attar"></p>
</li>
<li>
<p>在<code>main()</code>函数中创建<code>Person</code>对象<code>person</code>，再将<code>person</code>转为<code>Map</code>,再将<code>Map</code>转为了<code>Human</code></p>
</li>
<li>
<p>生成的两个文件内容如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Human$$ModelMap.kt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.ltt.projectcollection.kotlin.annotationlab</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kotlin.<span class="built_in">Int</span></span><br><span class="line"><span class="keyword">import</span> kotlin.String</span><br><span class="line"><span class="keyword">import</span> kotlin.collections.Map</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Human.<span class="title">toMap</span><span class="params">()</span></span> = mapOf(<span class="string">&quot;name&quot;</span> to name, <span class="string">&quot;age&quot;</span> to age)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;V&gt;</span> Map<span class="type">&lt;String, V&gt;</span>.<span class="title">toHuman</span><span class="params">()</span></span> = Human(<span class="keyword">this</span>[<span class="string">&quot;name&quot;</span>] <span class="keyword">as</span> String , <span class="keyword">this</span>[<span class="string">&quot;age&quot;</span>] <span class="keyword">as</span> <span class="built_in">Int</span> )</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Person$$ModelMap.kt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.ltt.projectcollection.kotlin.annotationlab</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kotlin.<span class="built_in">Int</span></span><br><span class="line"><span class="keyword">import</span> kotlin.String</span><br><span class="line"><span class="keyword">import</span> kotlin.collections.Map</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Person.<span class="title">toMap</span><span class="params">()</span></span> = mapOf(<span class="string">&quot;name&quot;</span> to name, <span class="string">&quot;age&quot;</span> to age, <span class="string">&quot;address&quot;</span> to address)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;V&gt;</span> Map<span class="type">&lt;String, V&gt;</span>.<span class="title">toPerson</span><span class="params">()</span></span> = Person(<span class="keyword">this</span>[<span class="string">&quot;name&quot;</span>] <span class="keyword">as</span> String , <span class="keyword">this</span>[<span class="string">&quot;age&quot;</span>] <span class="keyword">as</span> <span class="built_in">Int</span> ,</span><br><span class="line">   <span class="keyword">this</span>[<span class="string">&quot;address&quot;</span>] <span class="keyword">as</span> String )</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1><a href="#七-kotlin编译器插件" class="header-anchor">#</a><span id="七-kotlin编译器插件">七、<code>Kotlin</code>编译器插件</span></h1>
<h2><a href="#1-编译器插件工作机制" class="header-anchor">#</a><span id="1-编译器插件工作机制">1. 编译器插件工作机制</span></h2>
<p>在<code>Java</code>平台上，会将<code>*.kt</code>文件编译为<code>*.class</code>文件，而编译器插件会基于编译好的<code>*.class</code>文件直接修改该文件的内容，注解处理器会创建新的类参与编译。</p>
<h2><a href="#2-allopen插件" class="header-anchor">#</a><span id="2-allopen插件">2. <code>AllOpen</code>插件</span></h2>
<h3><a href="#1-allopen插件介绍" class="header-anchor">#</a><span id="1-allopen插件介绍">1. <code>AllOpen</code>插件介绍</span></h3>
<p><code>Kotlin</code> 的类及其成员默认是 <code>final</code> 的，可以使用<code>AllOpen</code>插件去掉<code>final</code>修饰符</p>
<p><code>AllOpen</code>插件包括两个插件：</p>
<ol>
<li><code>AllOpen-Intellij</code>：为开发者提供便利，可以在编写代码时直接继承由<code>AllOpen</code>插件去掉<code>final</code>修饰符的类</li>
<li><code>AllOpen-Gradle</code>：真正完成编译器插件逻辑</li>
</ol>
<h3><a href="#2-allopen插件源码" class="header-anchor">#</a><span id="2-allopen插件源码">2. <code>AllOpen</code>插件源码</span></h3>
<p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/JetBrains/kotlin/blob/master/plugins/allopen/allopen-cli/src/AllOpenDeclarationAttributeAltererExtension.kt">https://github.com/JetBrains/kotlin/blob/master/plugins/allopen/allopen-cli/src/AllOpenDeclarationAttributeAltererExtension.kt</a></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AllOpenDeclarationAttributeAltererExtension.kt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.jetbrains.kotlin.allopen</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractAllOpenDeclarationAttributeAltererExtension</span> : <span class="type">DeclarationAttributeAltererExtension</span>, <span class="type">AnnotationBasedExtension</span> &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> ANNOTATIONS_FOR_TESTS = listOf(<span class="string">&quot;AllOpen&quot;</span>, <span class="string">&quot;AllOpen2&quot;</span>, <span class="string">&quot;test.AllOpen&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">refineDeclarationModality</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        modifierListOwner: <span class="type">KtModifierListOwner</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        declaration: <span class="type">DeclarationDescriptor</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        containingDeclaration: <span class="type">DeclarationDescriptor</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        currentModality: <span class="type">Modality</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        isImplicitModality: <span class="type">Boolean</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: Modality? &#123;</span><br><span class="line">        <span class="keyword">if</span> (currentModality != Modality.FINAL || modifierListOwner.isPrivate()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> descriptor = declaration <span class="keyword">as</span>? ClassDescriptor ?: containingDeclaration ?: <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        <span class="keyword">if</span> (descriptor.hasSpecialAnnotation(modifierListOwner)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">if</span> (!isImplicitModality &amp;&amp; modifierListOwner.hasModifier(KtTokens.FINAL_KEYWORD))</span><br><span class="line">                Modality.FINAL <span class="comment">// Explicit final</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Modality.OPEN</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>在<code>refineDeclarationModality()</code>方法中实现去掉<code>final</code>的逻辑</li>
<li>先判断如果没有<code>final</code>修饰符，或类是<code>private</code>的话都不做任何处理</li>
<li>再定义一个属性<code>descriptor</code>值是强转为<code>ClassDescriptor</code>类型的<code>declaration</code>或是不为空的<code>containingDeclaration</code>，否则不做任何处理</li>
<li>之后判断类是否被对应的注解标注，若没有则不做处理</li>
<li>之后再判断是否手动添加的<code>final</code>，若是手动添加的则返回<code>final</code>，否则返回<code>open</code></li>
</ol>
<h2><a href="#3-noarg插件" class="header-anchor">#</a><span id="3-noarg插件">3. <code>NoArg</code>插件</span></h2>
<h3><a href="#1-noarg插件介绍" class="header-anchor">#</a><span id="1-noarg插件介绍">1. <code>NoArg</code>插件介绍</span></h3>
<p><code>NoArg</code>插件，给数据类加一个注解，使用数据类在编译时生成一个无参构造器，但无法在代码里直接访问该构造器，只能通过反射拿到</p>
<p><code>NoArg</code>插件包括两个插件：</p>
<ol>
<li><code>NoArg-Intellij</code>：为开发者提供便利，可以在反编译时直接看到生成的无参构造器</li>
<li><code>NoArg-Gradle</code>：真正完成编译器插件逻辑</li>
</ol>
<h3><a href="#2-noarg插件源码" class="header-anchor">#</a><span id="2-noarg插件源码">2. <code>NoArg</code>插件源码</span></h3>
<h4><a href="#1-noarg-gradle关键源码" class="header-anchor">#</a><span id="1-noarg-gradle关键源码">1. <code>NoArg-Gradle</code>关键源码</span></h4>
<p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/JetBrains/kotlin/blob/master/plugins/noarg/noarg-cli/src/AbstractNoArgExpressionCodegenExtension.kt">https://github.com/JetBrains/kotlin/blob/master/plugins/noarg/noarg-cli/src/AbstractNoArgExpressionCodegenExtension.kt</a></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AbstractNoArgExpressionCodegenExtension.kt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.jetbrains.kotlin.noarg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractNoArgExpressionCodegenExtension</span>(<span class="keyword">val</span> invokeInitializers: <span class="built_in">Boolean</span>) : ExpressionCodegenExtension,</span><br><span class="line">    AnnotationBasedExtension &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> ImplementationBodyCodegen.<span class="title">generateNoArgConstructor</span><span class="params">()</span></span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        functionCodegen.generateMethod(JvmDeclarationOrigin.NO_ORIGIN, constructorDescriptor, <span class="keyword">object</span> : CodegenBased(state) &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doGenerateBody</span><span class="params">(codegen: <span class="type">ExpressionCodegen</span>, signature: <span class="type">JvmMethodSignature</span>)</span></span> &#123;</span><br><span class="line">                codegen.v.load(<span class="number">0</span>, AsmTypes.OBJECT_TYPE)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (isParentASealedClassWithDefaultConstructor) &#123;</span><br><span class="line">                    codegen.v.aconst(<span class="literal">null</span>)</span><br><span class="line">                    codegen.v.visitMethodInsn(</span><br><span class="line">                        Opcodes.INVOKESPECIAL, superClassInternalName, <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;(Lkotlin/jvm/internal/DefaultConstructorMarker;)V&quot;</span>, <span class="literal">false</span></span><br><span class="line">                    )</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    codegen.v.visitMethodInsn(Opcodes.INVOKESPECIAL, superClassInternalName, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">false</span>)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (invokeInitializers) &#123;</span><br><span class="line">                    generateInitializers(codegen)</span><br><span class="line">                &#125;</span><br><span class="line">                codegen.v.visitInsn(Opcodes.RETURN)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>因为要添加一个无参的构造器，所以直接对字节码进行操作</li>
<li>其中有一条语句判断<code>invokeInitializers</code>是否为<code>true</code>：为<code>true</code>，则执行<code>generateInitializers()</code>方法，该方法用于生成构造器</li>
</ol>
<h4><a href="#2-noarg-intellij关键源码" class="header-anchor">#</a><span id="2-noarg-intellij关键源码">2. <code>NoArg-Intellij</code>关键源码</span></h4>
<p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/JetBrains/kotlin/blob/master/plugins/noarg/noarg-ide/src/IdeArgExpressionCodegenExtension.kt">https://github.com/JetBrains/kotlin/blob/master/plugins/noarg/noarg-ide/src/IdeArgExpressionCodegenExtension.kt</a></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//IdeArgExpressionCodegenExtension.kt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.jetbrains.kotlin.noarg.ide</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IdeNoArgExpressionCodegenExtension</span>(project: Project) : AbstractNoArgExpressionCodegenExtension(invokeInitializers = <span class="literal">false</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> cachedAnnotationsNames = CachedAnnotationNames(project, NO_ARG_ANNOTATION_OPTION_PREFIX)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getAnnotationFqNames</span><span class="params">(modifierListOwner: <span class="type">KtModifierListOwner</span>?)</span></span>: List&lt;String&gt; =</span><br><span class="line">        cachedAnnotationsNames.getAnnotationNames(modifierListOwner)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li><code>invokeInitializers</code>设置为了<code>false</code>，所以<code>IntelliJ</code>反编译<code>Kotlin</code>看不到<code>invokeInitializers</code>为<code>true</code>的效果</li>
</ol>
<h2><a href="#4-其它实用插件" class="header-anchor">#</a><span id="4-其它实用插件">4. 其它实用插件</span></h2>
<p><img src="/2021/03/23/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E5%85%AB/compiler_plugin_count.png" alt="attar"></p>
<table>
<thead>
<tr>
<th>常用插件名称</th>
<th>作用</th>
<th>适用范围</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>android-extensions</code></td>
<td>合成<code>View</code>属性、生成对应的字节码</td>
<td>省略了<code>findViewById</code>语句，可以直接使用布局文件中声明的<code>viewId</code>当作<code>View</code>的属性来访问<code>View</code></td>
</tr>
<tr>
<td>kotlin-serialization</td>
<td>为序列化类生成<code>serializer</code>,支持跨平台</td>
<td>用于数据类的序列化及反序列化，支持跨平台，生成的<code>serializer</code>可以给<code>java</code>平台生成字节码，还可以给<code>js</code>、<code>native</code>生成对应<code>javascript</code>、机器码等</td>
</tr>
</tbody>
</table>
<h2><a href="#5-总结" class="header-anchor">#</a><span id="5-总结">5. 总结</span></h2>
<p><code>Kotlin</code>编译器插件不仅支持<code>Java</code>平台，还支持<code>Js</code>平台、<code>Native</code>平台等，是跨平台的</p>
<table>
<thead>
<tr>
<th></th>
<th>注解处理器</th>
<th><code>Kotlin</code>编译器插件</th>
</tr>
</thead>
<tbody>
<tr>
<td>输出形式</td>
<td>源码</td>
<td>字节码</td>
</tr>
<tr>
<td>能力范围</td>
<td>新增类，不能修改</td>
<td>新增、修改已有类</td>
</tr>
<tr>
<td>依赖约束</td>
<td>依赖注解</td>
<td>可深入编译器细节</td>
</tr>
<tr>
<td><code>API</code>状态</td>
<td>稳定，公开</td>
<td>未公开，未来可期</td>
</tr>
<tr>
<td>支持平台</td>
<td><code>Java</code>虚拟机</td>
<td>跨平台</td>
</tr>
<tr>
<td>上手难度</td>
<td>要对<code>Java</code>编译过程有一些了解，熟悉符号表</td>
<td>掌握目标代码 <em>(字节码、机器码)</em> 生成</td>
</tr>
</tbody>
</table>
<h1><a href="#八-参考文章" class="header-anchor">#</a><span id="八-参考文章">八、 参考文章</span></h1>
<ol>
<li><a target="_blank" rel="noopener" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-metadata/">https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-metadata/</a></li>
<li><a target="_blank" rel="noopener" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.jvm/">https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.jvm/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/eb091dd229f6">正确使用Kotlin注解，兼容Java代码</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/af78a314c6fc">.java文件编译过程和执行过程分析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/92e4a6159a1a">Android APT（Java注解应用）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/899063e8452e">java-apt的实现之Element详解</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26000415/article/details/82352764">javax.lang.model.element源码解析</a></li>
</ol>
</p></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-03-23</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Kotlin/" title="Kotlin">Kotlin </a><i class="fa fa-tag"></i><a class="tag" href="/tags/注解/" title="注解">注解 </a><span class="leancloud_visitors"></span><span>大约15887个字, 52分钟57秒读完</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://puppet16.github.io/2021/03/23/kotlin学习系列八/,Puppet,kotlin 学习系列八：注解,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2021/04/15/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%B9%9D/" title="kotlin学习系列九：协程一">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2021/03/15/kotlin%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%B8%83/" title="kotlin学习系列七：反射">下一篇</a></li></ul></div><script src="/js/visitors.js"></script><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false, 
  verify:false|| false, 
  app_id:'xpSQCFiXzEQnCBUKrP6EHIUF-gzGzoHsz',
  app_key:'Ev5N03MrqLzS683mu92hf4RO',
  placeholder:'行至水穷处，坐看云起时...',
  path: window.location.pathname,
  serverURLs: '',
  visitor:true,
  recordIP:true,
  avatar:'mm'
})</script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><!-- Mermaid diagrams support--><script src="https://unpkg.com/mermaid@10.9.1/dist/mermaid.min.js"></script><script>if (window.mermaid) {
  mermaid.initialize({
    startOnLoad: true,
    securityLevel: 'loose',
    flowchart: { htmlLabels: true, useMaxWidth: true },
    classDiagram: {
      layout: 'elk',
      elk: {
        'elk.spacing.nodeNodeBetweenLayers': 200,
        'elk.spacing.nodeNode': 80
      }
    },
    theme: 'default',
    logLevel: 1
  });
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":20},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"dialog":{"enable":false,"hitokoto":true}});</script></body></html>